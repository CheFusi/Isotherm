---
title: "Dilution_and_Dose"
output: html_document
date: "2024-04-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries

```{r, message=FALSE}

libs_1<-c("tidyverse","knitr","psych","reshape2","rmarkdown")

#data manipulation/exploration
libs_2<-c("readxl","readr","tidyr","GGally","naniar","PUPAIM", "purrr")
# plotting
libs_3<-c("ggplot2","viridis","ggpubr","cowplot", "gridExtra")#,"ggthemr") 

#ggpubr = package for publishing
#cowplot=  #to create compounded figures

#tables
libs_4<-c("dplyr","stargazer","xlsx","ggplot2","scales","extrafont","writexl")

libs <- c(libs_1, libs_2, libs_3, libs_4)

# Suppress output unless there's an error
invisible(lapply(libs, require, character.only = TRUE, quietly = TRUE))

library(Metrics)
library(PerformanceAnalytics)
```

### Combining Dose and Dilutions

```{r}

#Dilution_Isotherm_All <- readRDS("Dilution_Isotherms_All.RDS")
Dilution_Isotherm_All_Act <- readRDS("Dilution_Isotherms_All_Act.RDS")
#Dose_Isotherm_All <- readRDS("Dose_Isotherms_All.RDS")
ALL_Biochars <- readRDS("ALL_Biochars.RDS")

Titration_no_AL <- readRDS("/Users/soliverchefusi/Library/CloudStorage/OneDrive-Personal/Desktop/Fusi/Acid_Base_Titration/Titration/Titration_no_AL.RDS")

```

```{r}

# Replace the Type_ox for the additional samples (K-O) with the appropriate label "AK_31" with "AK_30" in the Type_Ox column
# Dilution_Isotherm_All$AK_31$Type_ox <- gsub("AK_31", "AK_30", Dilution_Isotherm_All$AK_31$Type_ox)
# 
# Dilution_Isotherm_All$AK_06$Type_ox <- gsub("AK_06", "AK_05", Dilution_Isotherm_All$AK_06$Type_ox)
# 
# Dilution_Isotherm_All$AK_11$Type_ox <- gsub("AK_11", "AK_10", Dilution_Isotherm_All$AK_11$Type_ox)
# 
# Dilution_Isotherm_All$AM_16$Type_ox <- gsub("AM_16", "AM_15", Dilution_Isotherm_All$AM_16$Type_ox)

```

```{r}


# rbind all dataframes in the list into one dataframe
# Dilution_All <- do.call

Dilution_All <- Dilution_Isotherm_All_Act

# Extract unique values for each "Type_ox" in ALL_Biochars
unique_biochars <- unique(ALL_Biochars[, c("Type_ox", "OC", "SSA", "Type", "XPS_OC", "O", "CH",	"C_O",	"Carb", "pi_pi",	"KsP",	"Carb_pi_Ksp")])

# Merge the unique values with Dilution_All based on "Type_ox"
merged_df <- merge(Dilution_All, unique_biochars, by = "Type_ox", all.x = TRUE)

# Create a new column to store the index where the Type_ox values match
Dilution_All$match_idx <- match(Dilution_All$Type_ox, merged_df$Type_ox)

# Subsetting merged_df based on match_idx to ensure proper alignment
Dilution_All$OC <- merged_df$OC[Dilution_All$match_idx]
Dilution_All$SSA <- merged_df$SSA[Dilution_All$match_idx]
Dilution_All$Type <- merged_df$Type[Dilution_All$match_idx]
Dilution_All$XPS_OC <- merged_df$XPS_OC[Dilution_All$match_idx]
Dilution_All$O <- merged_df$O[Dilution_All$match_idx]
Dilution_All$CH <- merged_df$CH[Dilution_All$match_idx]
Dilution_All$Carb <- merged_df$Carb[Dilution_All$match_idx]
Dilution_All$C_O <- merged_df$C_O[Dilution_All$match_idx]
Dilution_All$pi_pi <- merged_df$pi_pi[Dilution_All$match_idx]
Dilution_All$KsP <- merged_df$KsP[Dilution_All$match_idx]
Dilution_All$Carb_pi_Ksp <- merged_df$Carb_pi_Ksp[Dilution_All$match_idx]

#Adding in Surface Area normalized Q 

Dilution_All <- Dilution_All %>%
  mutate(Q_NH4_avg_SSA = Q_NH4_avg / SSA)

#check
#Dilution_View <- merged_df %>%
  #select(Type_ox, OC, XPS_OC, OS_C, OD_C)# Q_NH4_avg, Qmax)
# Remove the match_idx column if no longer needed
Dilution_All$match_idx <- NULL


```

```{r}

Dilution_All$OX <- as.factor(Dilution_All$OX)

# Set NaN values to NA in the column "Ammonium_moles_eq_avg"
Dilution_All$Ammonium_moles_eq_avg[is.nan(Dilution_All$Ammonium_moles_eq_avg)] <- NA

ALL_Biochars_sub <- ALL_Biochars %>% filter(Type_ox %in% c("AK_05", "AK_10", "AK_15", "AK_30", "AM_05","AM_10","AM_15", "AN_30","AO_20"))

Dilution_All_sub <- Dilution_All %>% filter(Type_ox %in% c("AK_05", "AK_10", "AK_15", "AK_30", "AM_05","AM_10","AM_15", "AN_30","AO_20"))

# Extract common column names
common_col_names <- intersect(names(Dilution_All_sub), names(ALL_Biochars_sub))

ALL_Biochars_sub_2 <- (ALL_Biochars_sub[, common_col_names])

Diliution_All_sub_2 <- (Dilution_All_sub[, common_col_names])

# Perform right join based on common column names
#Dose_Dilution <- rbind(Dilution_All_sub[, common_col_names], ALL_Biochars_sub[, common_col_names])

#colnames_df1 <- colnames(Diliution_All)
#colnames_df2 <- colnames(Dose_Diliution)

# Find the column names that are unique to each dataframe
#unique_to_df1 <- setdiff(colnames_df1, colnames_df2)
#unique_to_df2 <- setdiff(colnames_df2, colnames_df1)

#unique_to_df1

#unique_to_df2
```

```{r}

Dose_Dilution <- rbind(transform(ALL_Biochars_sub_2, Shape = "Dose"),
                       transform(Diliution_All_sub_2, Shape = "Dilution"))

# # Define the mapping
# type_ox_mapping <- c("AK_05" = "0.20", "AK_10" = "0.23", "AK_15"= "0.25", "AK_30" = "0.30", "AM_05"= "0.13","AM_10" = "0.17","AM_15" = "0.18", "AN_30" = "0.14", "AO_20" = "0.25")
# 
# type_ox_xps_mapping <- c("AK_05" = "0.18", "AK_10" = "0.18", "AK_15"= "0.19", "AK_30" = "0.23", "AM_05"= "0.12","AM_10" = "0.16","AM_15" = "0.19", "AN_30" = "0.16", "AO_20" = "0.19") #Update AK_15
# 
# # Add a new column OC based on the mapping
# Dose_Dilution <- Dose_Dilution %>%
#   mutate(OC = type_ox_mapping[Type_ox],
#          OC_XPS = type_ox_xps_mapping[Type_ox] )

Dose_Dilution <- Dose_Dilution %>% filter(Q_NH4_avg >0)# & Q_NH4_avg<5)  
Dose_Dilution$OC <- as.numeric(Dose_Dilution$OC)
```

#### Add Net App H charge Diff

```{r}


# Extract unique values for each "Type_ox" in ALL_Biochars
unique_biochars <- unique(Titration_no_AL[, c("Type_ox", "net_app_H_diff_avg_abs")])

# Merge the unique values with Dilution_All based on "Type_ox"
merged_df <- merge(Dose_Dilution, unique_biochars, by = "Type_ox", all.x = TRUE)
merged_df_All <- merge(ALL_Biochars, unique_biochars, by = "Type_ox", all.x = TRUE)

# Create a new column to store the index where the Type_ox values match
Dose_Dilution$match_idx <- match(Dose_Dilution$Type_ox, merged_df$Type_ox)
ALL_Biochars$match_idx <- match(ALL_Biochars$Type_ox, merged_df_All$Type_ox)

# Subsetting merged_df based on match_idx to ensure proper alignment
Dose_Dilution$net_app_H_diff_avg_abs <- merged_df$net_app_H_diff_avg_abs[Dose_Dilution$match_idx]

ALL_Biochars$net_app_H_diff_avg_abs <- merged_df_All$net_app_H_diff_avg_abs[ALL_Biochars$match_idx]

```

### Separating Dilution and Dose Data

```{r}

Dilution_Data <- Dose_Dilution %>% filter(Shape == "Dilution")

#Removing additional points from AK5, AK10, AM15 and AK30 so all Dilution biochars have 10 isotherm points 

Dilution_Data <- Dilution_Data %>% filter(!(Type_ox %in% c("AK_05", "AK_10", "AM_15") & ID %in% c(2, 4, 6)) &
                                          !(Type_ox == "AK_30" & ID %in% c(2, 4, 6, 8, 10)))


Dose_Data <- Dose_Dilution %>% filter(Shape == "Dose")
```

### Filtering Data

-   Only retaining biochars with percent standard deviation \< 25% and Q-Qsd is greater than 0

-   ALL_Biochars_Qsd_25: samples where stdev is less than 25%

-   ALL_Biochars_High_C_diff: samples where stdev is less than 25% and the difference between initial and equilibrium concentrations are greater than 90 mg/L

```{r}

ALL_Biochars <- ALL_Biochars %>%
  filter (Q_NH4_avg >= 0 & Q_NH4_avg-Q_NH4_sd >= 0) 

Dose_Dilution <- Dose_Dilution %>% 
  filter (Q_NH4_avg >= 0 & Q_NH4_avg-Q_NH4_sd >= 0)

ALL_Biochars_Qsd_25 <- ALL_Biochars %>%
  filter (Q_NH4_avg_sd_perc <=25) #%>%
  #filter(Q_NH4_avg <= 3)

ALL_Biochars_High_C_diff <- ALL_Biochars %>%
  mutate(C_diff = Ammonium_moles_in_avg - Ammonium_moles_eq_avg ) %>%
  filter(C_diff >= 90)

ALL_Biochars_Qsd_25_High_C_diff <- ALL_Biochars_Qsd_25 %>%
  mutate(C_diff = Ammonium_moles_in_avg - Ammonium_moles_eq_avg ) %>%
  filter(C_diff >= 90)

ALL_Biochars_Qsd_25_Q_3 <- ALL_Biochars %>%
  filter (Q_NH4_avg_sd_perc <=25) %>%
  filter(Q_NH4_avg <= 2.5)

Dose_Dilution_Qsd_25_Q_3 <- Dose_Dilution %>%
  filter (Q_NH4_sd/Q_NH4_avg <=0.25) %>%
  filter(Q_NH4_avg <= 2.5)
```

### View AO and AL

```{r}

AO_AL_df <- ALL_Biochars_Qsd_25_High_C_diff %>%
  filter(Type %in% c("AL", "AO")) %>%
  select(C_diff, Type_ox)

ALL_Biochars_No_AL <- ALL_Biochars %>%
  filter (!Type %in% c("AL")) 

ALL_Biochars_Qsd_25_Q_3_No_AL <- ALL_Biochars_Qsd_25_Q_3 %>%
  filter (!Type %in% c("AL"))

```

### \*\* Dilution Only Plot

```{r, warning = FALSE}

Q_Conc_Plot<- ggplot(Dilution_Data,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.83),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") 
Q_Conc_Plot
```

### Dilution only Activity

```{r, warning=FALSE}

Q_Conc_Plot<- ggplot(Dilution_Data,aes(x = NH4_Act, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    #geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Activity (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.83),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") 
Q_Conc_Plot
```

### Dilution only XPS_OC

```{r}

Q_Conc_Plot<- ggplot(Dilution_Data,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = XPS_OC,border= XPS_OC, fill=XPS_OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.83),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") 
Q_Conc_Plot
```

### Surface Area Normalized Dilution Plot

```{r}

Q_Conc_Plot<- ggplot(Dilution_Data,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg_SSA, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    #geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   #geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/m2 biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.83),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") 
Q_Conc_Plot
```

### Dose Only Plot

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

### Dose only plot- XPS

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = XPS_OC,border= XPS_OC, fill=XPS_OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

### \*\*Dose only no AL

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_No_AL,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot


```

### \*\*Dose only no AL Activity

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_No_AL,aes(x = NH4_Act, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    #geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Activity (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot


```

### Dose Only No AL SSA Normialized

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_No_AL,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg_SSA, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    #geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   #geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot

```

### %%%% Dose Only Qsd\< 25%

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Qsd_25,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

### \*\* Dose Only Q \< 3, Qsd \< 25%

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Qsd_25_Q_3_No_AL,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 24, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

### \*\* Dose Only Q \< 3, Qsd \< 25% Activity

```{r}


Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Qsd_25_Q_3_No_AL,aes(x = NH4_Act, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 24, size = 6, stroke = 2, color = "black") +
    #geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Activity (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

### 

```{r}
 
Dose_low_Q <- ALL_Biochars %>% filter (OC >0.18 & OC <= 0.21)

Q_Conc_Dose_Plot<- ggplot(Dose_low_Q,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.01, 0.01),  # Adjust the legend position as needed
    legend.direction = "horizontal", # Make the legend horizontal
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

```{r}

Dose_high_Q <- ALL_Biochars %>% filter (OC > 0.22)

Q_Conc_Dose_Plot<- ggplot(Dose_high_Q,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.1),  # Adjust the legend position as needed
    legend.direction = "horizontal", # Make the legend horizontal
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot

```

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   #facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/m2 biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") +
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  scale_y_continuous(expand = c(0,0), limits = c(-0.2,3))
Q_Conc_Dose_Plot 
```

```{r}

Q_Conc_Plot<- ggplot(Dose_Dilution,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, shape = Shape, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
    scale_shape_manual(values = c("Dose" = 16, "Dilution" = 10)) +
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Plot
```

Dose & Dilution plots

```{r, warning=FALSE}

Dose_Dilution_low_Q <- Dose_Dilution %>% filter (OC < 0.19)
Dose_Dilution_high_Q <- Dose_Dilution %>% filter (OC > 0.19)

Q_Conc_Plot<- ggplot(Dose_Dilution_low_Q,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, shape = Shape, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ OC, scales = "free")+ ###to separate into 3 plots
    scale_shape_manual(values = c("Dose" = 16, "Dilution" = 10)) +
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.8, 0.1),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,2))
Q_Conc_Plot
```

```{r}

Q_Conc_Plot <- ggplot(Dose_Dilution, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, border = "black", shape = Shape, fill = OC, na.rm = TRUE)) +
  geom_point(size = 6, stroke = 1) +
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  scale_shape_manual(values = c("Dose" = 15, "Dilution" = 16)) +  # Assign different shapes based on the "Shape" variable
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "bottom",  # Position the legend at the bottom
    legend.direction = "horizontal",  # Display the legend horizontally
    legend.justification = "right",  # Justify the legend to the right
    legend.box.just = "right",  # Justify the legend box to the right
    #legend.position = c(0.1, 0.7),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 18),
    legend.key.size = unit(0.7, "lines"),  # Adjust the size of the legend key
    legend.box.background = element_rect(color = "black", size = 0.9, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0, 0), limits = c(-15, 650)) +
  #scale_y_continuous(expand = c(0, 0), limits = c(-0.2, 4))

Q_Conc_Plot
```

### \*\* Combined Dose-Dilution Plot

```{r, warning= False}

Q_Conc_Plot <- ggplot(Dose_Dilution_Qsd_25_Q_3, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, shape = Shape, fill = OC)) +
  geom_point(size = 6, stroke = 2, color = "black") +  # Outline shapes with a black line
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  scale_shape_manual(values = c("Dose" = 24, "Dilution" = 21)) +  # Use shapes that support the fill and stroke aesthetics
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.3, 0.9),  # Move legend 
    legend.direction = "horizontal",  # Set legend direction to horizontal
    legend.box = "horizontal",
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 15),
    legend.key.size = unit(1.2, "lines"),  # Adjust the size of the legend key
    legend.box.background = element_rect(color = "black", size = 0.5, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none") 

Q_Conc_Plot
```

### \*\* Combined Dose-Dilution Plot Activity

```{r, warning=FALSE}

Q_Conc_Plot <- ggplot(Dose_Dilution_Qsd_25_Q_3, aes(x = NH4_Act, y = Q_NH4_avg, color = OC, shape = Shape, fill = OC)) +
  geom_point(size = 6, stroke = 2, color = "black") +  # Outline shapes with a black line
  #geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  scale_shape_manual(values = c("Dose" = 24, "Dilution" = 21)) +  # Use shapes that support the fill and stroke aesthetics
  xlab("Equilibrium Activity (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.3, 0.9),  # Move legend 
    legend.direction = "horizontal",  # Set legend direction to horizontal
    legend.box = "horizontal",
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 15),
    legend.key.size = unit(1.2, "lines"),  # Adjust the size of the legend key
    legend.box.background = element_rect(color = "black", size = 0.5, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none") 

Q_Conc_Plot
```

```{r, warning=FALSE}

Q_Conc_Plot <- ggplot(Dose_Dilution, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, border = "black", shape = Shape, fill = OC, na.rm = TRUE)) +
  geom_point(size = 6, stroke = 1) +
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  facet_wrap(~ OC, scales = "free") +
  scale_shape_manual(values = c("Dose" = 15, "Dilution" = 16)) +  # Assign different shapes based on the "Shape" variable
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "bottom",  # Position the legend at the bottom
    legend.direction = "horizontal",  # Display the legend horizontally
    legend.justification = "right",  # Justify the legend to the right
    legend.box.just = "right",  # Justify the legend box to the right
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 18),
    legend.key.size = unit(0.9, "lines"),  # Adjust the size of the legend key
    legend.box.background = element_rect(color = "black", size = 0.9, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0, 0), limits = c(-15, 650)) +
  #scale_y_continuous(expand = c(0, 0), limits = c(-0.2, 3.2))

Q_Conc_Plot

```

### Dose only Plot - AO and AL

```{r}

ALL_Biochars_Only_AL_AO <- ALL_Biochars%>% filter((Type %in% c( "AL", "AO")))

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Only_AL_AO,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Only_AL_AO,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") +
  scale_x_continuous(expand = c(0,0), limits = c(-15,600))+
  scale_y_continuous(expand = c(0,0), limits = c(-0.2,3))
Q_Conc_Dose_Plot
```

## Dilution Isotherms

### Langmuir Isotherm Manual

```{r}

# # Define the Langmuir function
# Langmuir <- function(C, Qmax, K) {
#   Qmax * K * C / (1 + (K * C))
# }
# 
# # Function to fit Langmuir isotherm and extract Qmax
# fit_langmuir <- function(df) {
#   # Fit Langmuir isotherm
#   fit <- nls(Q_NH4_avg ~ Langmuir(Ammonium_moles_eq_avg, Qmax, K),
#              data = df,
#              start = list(Qmax = max(df$Q_NH4_avg), K = 0.005),  # Initial parameter guesses
#              na.action = na.exclude,# Exclude rows with missing values
#              control = nls.control(maxiter = 1000)) #increase max number of iterations  
#   
#   # Extract Qmax value from the fit
#   Qmax <- coef(fit)["Qmax"]
#   
#   # Create a new column with Qmax value repeated for each row
#   df$Qmax <- Qmax
#   
#   return(df)
# }
# 
# Dilution_Data <- Dilution_Data %>%
#   group_by(Type_ox) %>%
#   #filter(Type_ox %in% c("AN_30")) %>%
#   mutate(Qmax = fit_langmuir(cur_data())$Qmax)  # Extract Qmax value directly
# 
# Dilution_Data$Qmax <- as.numeric(Dilution_Data$Qmax)
# #Dilution_Data$OC_XPS <- as.numeric(Dilution_Data$OC_XPS)
# 
# #langmuir_fit <- langmuiranalysis(Dilution_Isotherm_All$AN_30$Ammonium_moles_eq_avg, Dilution_Isotherm_All$AN_30$Q_NH4_avg)
# #langmuir_fit

# Define the Langmuir function
Langmuir <- function(C, Qmax, K) {
  Qmax * K * C / (1 + K * C)
}

# Function to fit Langmuir isotherm and extract Qmax
fit_langmuir <- function(df) {
  # Try a range of initial guesses to avoid singular gradient issues
  start1 <- expand.grid(Qmax = seq(0, 100, length.out = 10), K = seq(0.001, 100, length.out = 10))
  
  
  tryCatch({
    # Fit Langmuir isotherm
    fit <- nls2::nls2(Q_NH4_avg ~ Langmuir(Ammonium_moles_eq_avg, Qmax, K),
                      data = df,
                      start = start1,  # Multiple starting points
                      na.action = na.exclude, # Exclude rows with missing values
                      control = nls.control(maxiter = 50, minFactor = 1e-8),
                      algorithm = "port") # Increase max iterations and decrease minFactor
    
    # Extract Qmax value from the fit
    Qmax <- coef(fit)["Qmax"]
    
    # Create a new column with Qmax value repeated for each row
    df$Qmax <- Qmax
  }, error = function(e) {
    # Handle errors by assigning NA to Qmax and returning the dataframe
    df$Qmax <- NA
    message("Error fitting Langmuir model for Type_ox =", unique(df$Type_ox), ": ", e$message)
  })
  
  return(df)
}

Dilution_Data <- Dilution_Data %>%
  group_by(Type_ox) %>%
  do(fit_langmuir(.)) %>%
  ungroup() # Ungroup after processing

Dilution_Data$Qmax <- as.numeric(Dilution_Data$Qmax)


```

### Langmuir with R PUPAIM Package

```{r}

# # Function to fit Langmuir isotherm using PUPAIM and extract Qmax
# fit_langmuir_pupaim <- function(df) {
#   tryCatch({
#     # Prepare data for PUPAIM
#     C <- df$Ammonium_moles_eq_avg
#     Q <- df$Q_NH4_avg
#     
#     # Fit Langmuir isotherm using PUPAIM
#     langmuir_fit <- langmuiranalysis(C, Q)
#     
#     # Extract Qmax value from the fit
#     Qmax_R <- langmuir_fit$plot_env$pars_Qmax
# 
#     
#     # Create a new column with Qmax value repeated for each row
#     df$Qmax_R <- Qmax_R
#     
#     return(df)
#   }, error = function(e) {
#     message("Error fitting Langmuir model for Type_ox =", unique(df$Type_ox), ": ", e$message)
#     df$Qmax_R <- NA  # Assign NA if fitting fails
#     return(df)
#   })
# }
# 
# Dilution_Data <- Dilution_Data %>%
#   #filter(Q_NH4_avg <= 3) %>%
#   group_by(Type_ox) %>%
#   do(fit_langmuir_pupaim(.)) %>%
#   ungroup() # Ungroup after processing
# 
# # Convert Qmax to numeric
# #Dilution_Data$Qmax <- as.numeric(Dilution_Data$Qmax)
# 
# #langmuir_fit_test <- langmuiranalysis(Dilution_Data$Ammonium_moles_eq_avg[c(1:13)],Dilution_Data$Q_NH4_avg[c(1:13)])
# #Qmax <- langmuir_fit_test$plot_env$pars_Qmax


```

### \*\*\* Langmuir Dilution Plot

```{r}

# Define the Langmuir function
Langmuir <- function(C, Qmax, K) {
  Qmax * K * C / (1 + K * C)
}

# Function to fit Langmuir isotherm and extract Qmax, K, and R2
fit_langmuir <- function(df) {
  # Try a range of initial guesses to avoid singular gradient issues
  start1 <- expand.grid(Qmax = seq(0, 100, length.out = 10), K = seq(0.001, 100, length.out = 10))
  
  tryCatch({
    # Fit Langmuir isotherm
    fit <- nls2::nls2(Q_NH4_avg ~ Langmuir(Ammonium_moles_eq_avg, Qmax, K),
                      data = df,
                      start = start1,  # Multiple starting points
                      na.action = na.exclude, # Exclude rows with missing values
                      control = nls.control(maxiter = 50, minFactor = 1e-8),
                      algorithm = "port") # Increase max iterations and decrease minFactor
    
    # Extract coefficients from the fit
    coefs <- coef(fit)
    
    # Calculate fitted values
    fitted_values <- Langmuir(df$Ammonium_moles_eq_avg, coefs["Qmax"], coefs["K"])
    
    # Calculate R2 value
    ss_total <- sum((df$Q_NH4_avg - mean(df$Q_NH4_avg))^2)
    ss_residual <- sum((df$Q_NH4_avg - fitted_values)^2)
    R2 <- 1 - (ss_residual / ss_total)
    
    # Add the fitted values to the original dataframe
    df$Q_NH4_fit_Lang <- fitted_values
    df$Qmax_Lang <- coefs["Qmax"]
    df$K_Lang <- coefs["K"]
    df$R2_Lang <- R2
  }, error = function(e) {
    # Handle errors by assigning NA to Qmax, K, Q_NH4_fit, and R2
    df$Qmax_Lang <- NA
    df$K_Lang <- NA
    df$Q_NH4_fit_Lang <- NA
    df$R2_Lang <- NA
    message("Error fitting Langmuir model for Type_ox =", unique(df$Type_ox), ": ", e$message)
  })
  
  return(df)
}

Dilution_Data <- Dilution_Data %>%
  group_by(Type_ox) %>%
  do(fit_langmuir(.)) %>%
  ungroup() # Ungroup after processing

Dilution_Data$Qmax_Lang <- as.numeric(Dilution_Data$Qmax_Lang)
Dilution_Data$K_Lang <- as.numeric(Dilution_Data$K_Lang)
Dilution_Data$R2_Lang <- as.numeric(Dilution_Data$R2_Lang)


# Extract the parameters into a new dataframe
Dilution_Lang_parameters <- Dilution_Data %>%
  select(Type_ox, Qmax_Lang, K_Lang, R2_Lang) %>%
  distinct() # Ensure unique entries
```

### \*\*\* Dilution with Langmuir Fits

```{r}


# Plot the data along with the Langmuir isotherm line for each sample
Q_Conc_Plot <- ggplot(Dilution_Data, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, fill = OC, na.rm = TRUE)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  geom_line(aes(y = Q_NH4_fit_Lang, group = Type_ox), linetype = "solid", size = 1.5) + # Add Langmuir isotherm line for each sample
  facet_wrap(~ Type_ox, scales = "fixed") +
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, -0.2),  # Adjusted legend position
    legend.direction = "horizontal",
    legend.key.width = unit(1, "cm"),  # Make legend wider
    legend.key.height = unit(0.5, "cm"),  # Make legend thinner
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    plot.margin = margin(5, 5, 50, 5),  # Increased bottom margin to make space for the legend
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow") +
  guides(fill = "none")

Q_Conc_Plot


Q_Conc_Plot
```

### Dilution Data - w/o Replciate OC and Qmax for s

```{r}

# Filter the data to include only unique rows based on Type_ox
unique_Dilution_data <- Dilution_Data %>% distinct(Type_ox, .keep_all = TRUE)
```

### \*\* Dilution Qmax Plot - Manual Langmuir

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data, aes(x = OC, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ OC, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Dilution Qmax Plot Bulk OC - R Langmuir

```{r, warning=FALSE}

# # Create the plot with unique data
# Qmax_Plot <- ggplot(unique_Dilution_data, aes(x = OC, y = Qmax_R, color = Type, fill = Type)) +
#   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
#   geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
#   xlab("OC Bulk") +
#   ylab("Q max (mmol NH4/g biochar)") +
#   theme_classic(base_size = 28) +
#   theme(
#     text = element_text(family = "Times"),
#     legend.position = c(0.1, 0.8),
#     axis.text.x = element_text(size = 24),
#     axis.text.y = element_text(size = 24),
#     axis.title.x = element_text(margin = margin(t = 20), size = 24),
#     axis.title.y = element_text(margin = margin(r = 20), size = 24),
#     panel.border = element_rect(color = "black", fill = NA, size = 3),
#     legend.text = element_text(size = 20),
#     legend.title = element_text(size = 24),
#     legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
#   )
# 
# # Fit the linear regression model to the unique data
# lm_model <- lm(Qmax_R ~ OC, data = unique_Dilution_data)
# 
# # Summary of the regression model
# summary_lm <- summary(lm_model)
# 
# # Calculate R-squared value and regression details
# r_squared <- summary_lm$r.squared
# p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
# equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
# significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))
# 
# # Extract the F-statistic and degrees of freedom
# f_statistic <- summary_lm$fstatistic[1]
# df1 <- summary_lm$fstatistic[2]
# df2 <- summary_lm$fstatistic[3]
# 
# # Extract the standard deviation of residuals (example of what S25 could represent)
# residual_sd <- sd(summary_lm$residuals)
# 
# # Output the regression details
# cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
# cat("R^2: ", round(r_squared, 2), "\n")
# cat("p-value: ", p_value, "(", significance, ")\n")
# cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
# cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")
# 
# # Add R-squared value to the plot
# Qmax_Plot <- Qmax_Plot +
#   geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
#             hjust = 1, vjust = 5, color = "black", size = 6)
# 
# # Display the plot
# print(Qmax_Plot)

```

### \*\* Dilution Qmax Plot Surface OC- Manual Langmuir

```{r}

unique_Dilution_data_XPS <- unique_Dilution_data %>% filter(!is.na(XPS_OC))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data_XPS, aes(x = XPS_OC, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Surface") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ XPS_OC, data = unique_Dilution_data_XPS)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\* Dilution Qmax Plot Net App H- Manual Langmuir

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data, aes(x = net_app_H_diff_avg_abs, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.7, 0.2),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ net_app_H_diff_avg_abs, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Langmuir Dilution Outlier

```{r}

unique_Dilution_data_Carb <- unique_Dilution_data %>%
  filter (Carb_pi_Ksp <= 0.24)
```

### \*\* Dilution Qmax Plot (C=O)-O Manual Langmuir

```{r, warning=FALSE}


# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data_Carb, aes(x = Carb, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("(C=O)-O") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ Carb, data = unique_Dilution_data_Carb)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(Carb), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Dilution Qmax Plot Bulk OC- Manual Langmuir (NO AO )

```{r}

unique_Dilution_data_No_AO <- unique_Dilution_data %>% filter (Type != "AO")
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data_No_AO, aes(x = OC, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.7, 0.2),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ OC, data = unique_Dilution_data_No_AO)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Dilution Qmax Plot Surface OC- Manual Langmuir (NO AO )

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data_No_AO, aes(x = XPS_OC, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.7, 0.2),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ XPS_OC, data = unique_Dilution_data_No_AO)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Dilution Qmax Plot Net App H- Manual Langmuir (NO AO )

```{r}
 unique_Dilution_data_No_AO <- unique_Dilution_data %>% filter (Type != "AO")

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data_No_AO, aes(x = net_app_H_diff_avg_abs, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.7, 0.2),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ net_app_H_diff_avg_abs, data = unique_Dilution_data_No_AO)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

## Dose Isotherms

## Dose - Freundlich Isotherm

### Freundlich Formula - Q_400

```{r, warning=FALSE}

# Define the Freundlich fitting function with plotting and Q_400 calculation
fit_freundlich_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Freundlich isotherm using PUPAIM (replace with actual function)
    freundlich_fit <- freundlichanalysis(C, Q)  # This is a placeholder for the actual fitting function
    
    # Extract parameters from the fitted model
    Kf <- freundlich_fit$plot_env$pars_KF
    n <- freundlich_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    C_target <- 300
    Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    df$Q_400 <- Q_400
    
    # Create a plot
    df$Predicted <- Kf * (C ^ (1/n))
    p <- ggplot(df, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg)) +
      geom_point() +
      geom_line(aes(y = Predicted), color = "blue") +
      labs(title = paste("Freundlich Fit for Type_ox =", unique(df$Type_ox)),
           x = "Ammonium_moles_eq_avg",
           y = "Q_NH4_avg") +
      theme_minimal()
    
    # Print the plot
    print(p)
    
    # Return both the modified dataframe and the plot
    #list(data = df, plot = p)
  }, error = function(e) {
    message("Error fitting Freundlich model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}

```

### \*\*\* Freundlich Fit Dilution

```{r}


# Define the Freundlich fitting function with plotting and Q_400 calculation
fit_freundlich_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Freundlich isotherm using PUPAIM (replace with actual function)
    freundlich_fit <- freundlichanalysis(C, Q)  # This is a placeholder for the actual fitting function
    
    # Extract parameters from the fitted model
    Kf <- freundlich_fit$plot_env$pars_KF
    n <- freundlich_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    C_target <- 400
    Q_400 <- Kf * C_target^(1/n)
    
    # Calculate fitted values
    fitted_values <- Kf * (C ^ (1/n))
    
    # Calculate R2 value
    ss_total <- sum((Q - mean(Q))^2)
    ss_residual <- sum((Q - fitted_values)^2)
    R2 <- 1 - (ss_residual / ss_total)
    
    # Add the fitted values and parameters to the original dataframe
    df$Q_NH4_fit_Freundlich <- fitted_values
    df$Kf_Freundlich <- Kf
    df$n_Freundlich <- n
    df$R2_Freundlich <- R2
    df$Q_400_Freundlich <- Q_400
    
    # Create a plot
    df$Predicted <- fitted_values
    p <- ggplot(df, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg)) +
      geom_point() +
      geom_line(aes(y = Predicted), color = "blue") +
      labs(title = paste("Freundlich Fit for Type_ox =", unique(df$Type_ox)),
           x = "Ammonium_moles_eq_avg",
           y = "Q_NH4_avg") +
      theme_minimal()
    
    # Print the plot
    print(p)
    
    return(df)
  }, error = function(e) {
    message("Error fitting Freundlich model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    df$Kf_Freundlich <- NA
    df$n_Freundlich <- NA
    df$R2_Freundlich <- NA
    df$Q_400_Freundlich <- NA
    df$Q_NH4_fit_Freundlich <- NA
    return(df)
  })
}


```

## Freundlich Fit Dilution

```{r}

# Apply the fitting function to each group and update the dataframe
Dilution_Data <- Dilution_Data %>%
  group_by(Type_ox) %>%
  do(fit_freundlich_pupaim(.)) %>%
  ungroup()

# Extract the parameters into a new dataframe
Dilution_Freundlich_parameters <- Dilution_Data %>%
  select(Type_ox, Kf_Freundlich, n_Freundlich, R2_Freundlich, Q_400_Freundlich) %>%
  distinct()  # Ensure unique entries

unique_Dilution_data <- Dilution_Data %>% distinct(Type_ox, .keep_all = TRUE)


```

## \*\*Freundlich Dilution Plots

```{r}

# Plot the data along with the Langmuir isotherm line for each sample
Q_Conc_Plot <- ggplot(Dilution_Data, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, fill = OC, na.rm = TRUE)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  geom_line(aes(y = Q_NH4_fit_Freundlich, group = Type_ox), linetype = "solid", size = 1.5) + # Add Freundlich isotherm line for each sample
  facet_wrap(~ Type_ox, scales = "fixed") +
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, -0.2),  # Adjusted legend position
    legend.direction = "horizontal",
    legend.key.width = unit(1, "cm"),  # Make legend wider
    legend.key.height = unit(0.5, "cm"),  # Make legend thinner
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    plot.margin = margin(5, 5, 50, 5),  # Increased bottom margin to make space for the legend
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow") +
  guides(fill = "none")

Q_Conc_Plot

```

### \*\* Freundlich Dilution Bulk OC

```{r, warning=FALSE}


# Create the plot with unique data
Q_300_Freund_Plot <- ggplot(unique_Dilution_data, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ OC, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Q_300_Freund_Plot <- Q_300_Freund_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Q_300_Freund_Plot)

```

### \*\* Freundlich Dilution Surface OC

```{r, warning=FALSE}


# Create the plot with unique data
Q_300_Freund_Plot <- ggplot(unique_Dilution_data, aes(x = XPS_OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Surface") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ XPS_OC, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Q_300_Freund_Plot <- Q_300_Freund_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Q_300_Freund_Plot)

```

### \*\* Freundlich Dilution Net App

```{r, warning=FALSE}

# Create the plot with unique data
Q_300_Freund_Plot <- ggplot(unique_Dilution_data, aes(x = net_app_H_diff_avg_abs, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ net_app_H_diff_avg_abs, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Q_300_Freund_Plot <- Q_300_Freund_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Q_300_Freund_Plot)


```

### Freundlich Dilution Carb_pi

```{r}


# Create the plot with unique data
Q_300_Freund_Plot <- ggplot(unique_Dilution_data, aes(x = Carb_pi_Ksp, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("(C=O)-O All") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb_pi_Ksp, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Q_300_Freund_Plot <- Q_300_Freund_Plot +
  geom_text(aes(x = max(Carb_pi_Ksp), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Q_300_Freund_Plot)

```

### Freundlich Dilution Carb only

```{r}

# Create the plot with unique data
Q_300_Freund_Plot <- ggplot(unique_Dilution_data, aes(x = Carb, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("(C=O)-O") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Q_300_Freund_Plot <- Q_300_Freund_Plot +
  geom_text(aes(x = max(Carb), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Q_300_Freund_Plot) 


```

### Freundlich Dilution Outlier

```{r}

unique_Dilution_data_Carb <- unique_Dilution_data %>%
  filter (Carb_pi_Ksp <= 0.24)
```

### Freundlich Dilution Carb_pi no Outlier

```{r}


# Create the plot with unique data
Q_300_Freund_Plot <- ggplot(unique_Dilution_data_Carb, aes(x = Carb_pi_Ksp, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("(C=O)-O All") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb_pi_Ksp, data = unique_Dilution_data_Carb)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Q_300_Freund_Plot <- Q_300_Freund_Plot +
  geom_text(aes(x = max(Carb_pi_Ksp), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Q_300_Freund_Plot)

```

### Freundlich Dilution Carb only no Outlier

```{r, warning=FALSE}

# Create the plot with unique data
Q_300_Freund_Plot <- ggplot(unique_Dilution_data_Carb, aes(x = Carb, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("(C=O)-O") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb, data = unique_Dilution_data_Carb)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Q_300_Freund_Plot <- Q_300_Freund_Plot +
  geom_text(aes(x = max(Carb), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Q_300_Freund_Plot) 


```

### Freundlich Fit Dose

```{r}

# Apply the fitting function to each group and update the dataframe
ALL_Biochars_Freund <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do(fit_freundlich_pupaim(.)) %>%
  ungroup()

ALL_Biochars_Freund <- ALL_Biochars_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)

# Extract the parameters into a new dataframe
ALL_Biochars_Freund_parameters <- ALL_Biochars_Freund %>%
  select(Type_ox, Kf_Freundlich, n_Freundlich, R2_Freundlich, Q_400_Freundlich) %>%
  distinct()  # Ensure unique entries

unique_Dilution_data <- Dilution_Data %>% distinct(Type_ox, .keep_all = TRUE)

```

```{r, warning=FALSE}

ALL_Biochars_Qsd_25_Freund <- ALL_Biochars_Qsd_25 %>%
  group_by(Type_ox) %>%
  do(fit_freundlich_pupaim(.)) %>%
  ungroup()

ALL_Biochars_Qsd_25_Freund <- ALL_Biochars_Qsd_25_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)
```

```{r}

ALL_Biochars_High_C_diff_Freund  <- ALL_Biochars_High_C_diff %>%
  group_by(Type_ox) %>%
  do(fit_freundlich_pupaim(.)) %>%
  ungroup()

ALL_Biochars_High_C_diff_Freund <- ALL_Biochars_High_C_diff_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)
```

```{r}

ALL_Biochars_Qsd_25_Q_3_Freund <- ALL_Biochars_Qsd_25_Q_3 %>% 
  group_by(Type_ox) %>%
  do(fit_freundlich_pupaim(.)) %>%
  ungroup()

ALL_Biochars_Qsd_25_Q_3_Freund <- ALL_Biochars_Qsd_25_Q_3_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)
```

## Freundlich Dose Plots

### Dose Q-400 Plot Freundlich All Biochars

```{r}


Qmax_Plot <- ggplot(ALL_Biochars_Freund, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-400 Plot Freundlich Qsd 25%

```{r}


Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Freund, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Qsd_25_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-400 Plot Freundlich Qsd 25% no AO, AL

```{r}

ALL_Biochars_Qsd_25_Freund_no_AO_AL<- ALL_Biochars_Qsd_25_Freund%>%
    filter(!(Type %in% c("AO", "AL")))

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Freund_no_AO_AL, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Qsd_25_Freund_no_AO_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference

```{r}

Qmax_Plot <- ggplot(ALL_Biochars_High_C_diff_Freund, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_High_C_diff_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference \$ Qsd \>25%

```{r}
ALL_Biochars_Qsd_25_High_C_diff_Freund  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do(fit_freundlich_pupaim(.)) %>%
  ungroup()

ALL_Biochars_Qsd_25_High_C_diff_Freund <- ALL_Biochars_Qsd_25_High_C_diff_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)

#freundlich_fit_test <- freundlichanalysis(ALL_Biochars_Qsd_25$Ammonium_moles_eq_avg[c(1:13)],ALL_Biochars_Qsd_25$Q_NH4_avg[c(1:13)])
#Qmax <- langmuir_fit_test$plot_env$pars_Qmax
```

```{r}

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_High_C_diff_Freund, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Qsd_25_High_C_diff_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference - No AO, AL

```{r}

ALL_Biochars_High_C_diff_Freund_no_AO_AL <- ALL_Biochars_High_C_diff_Freund %>%
    filter(!(Type %in% c("AO", "AL")))

Qmax_Plot <- ggplot(ALL_Biochars_High_C_diff_Freund_no_AO_AL, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_High_C_diff_Freund_no_AO_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich - No AO, AL

```{r}


ALL_Biochars_Freund_no_AO_AL <- ALL_Biochars_Freund %>% 
    filter(!(Type %in% c("AO", "AL")))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_no_AO_AL, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Freund_no_AO_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich -All biochars No AO

```{r}


ALL_Biochars_Freund_no_AO <- ALL_Biochars_Freund %>% filter (Type != c("AO"))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_no_AO, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Freund_no_AO)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference - Only AO

```{r}


ALL_Biochars_Freund_High_C_diff_AO <- ALL_Biochars_Freund %>% filter (Type == c("AO"))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_High_C_diff_AO, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Freund_High_C_diff_AO)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

```{r}


ALL_Biochars_Freund_High_C_diff_AL <- ALL_Biochars_Freund %>% filter (Type == c("AL"))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_High_C_diff_AL, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Freund_High_C_diff_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich Q \< 3, Qsd \<25%

```{r, warning=FALSE}

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Qsd_25_Q_3_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### \*\* Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL

```{r}

ALL_Biochars_Qsd_25_Q_3_Freund_No_AL <- ALL_Biochars_Qsd_25_Q_3_Freund %>% filter (Type != c("AL"))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ OC, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\*Q-Plot Freundlich Q \< 3, Qsd \<25%, No AL - OC_XPS

```{r}

# Filter out missing or non-finite values
ALL_Biochars_Qsd_25_Q_3_Freund_No_AL <- ALL_Biochars_Qsd_25_Q_3_Freund %>% 
  filter(Type != "AL" & !is.na(XPS_OC) & !is.na(Q_400_Freundlich))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = XPS_OC, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Surface") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ XPS_OC, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL -COO

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = Carb_pi_Ksp, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("C=O)-O") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb_pi_Ksp, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(Carb_pi_Ksp), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)


```

### Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL - COO_pi no outlier

```{r}

ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_Carb <- ALL_Biochars_Qsd_25_Q_3_Freund_No_AL %>%
  filter (Carb_pi_Ksp <= 0.24)
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_Carb, aes(x = Carb_pi_Ksp, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("(C=O)-O") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb_pi_Ksp, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_Carb)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(Carb_pi_Ksp), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)
```

### Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL - Carb only

```{r}



# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = Carb, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("C=O)-O") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(Carb), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

```{r, warning=FALSE}


# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_Carb, aes(x = Carb, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("C=O)-O") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ Carb, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_Carb)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(Carb), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)


```

### Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL Net App Diff

```{r, warning=FALSE}

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = net_app_H_diff_avg_abs, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ net_app_H_diff_avg_abs, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)
```

### \*\*Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL, No AO Net App Diff

```{r}
ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_No_AO <- ALL_Biochars_Qsd_25_Q_3_Freund %>% 
  filter(!Type %in% c("AL","AO") & !is.na(XPS_OC) & !is.na(Q_400_Freundlich))
```

```{r, warning=FALSE}

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_No_AO, aes(x = net_app_H_diff_avg_abs, y = Q_400_Freundlich, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400_Freundlich ~ net_app_H_diff_avg_abs, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL_No_AO)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Q_400_Freundlich), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)
```

#### General non-Linear fit

```{r}

# Function to fit data with a nonlinear model
fit_nonlinear <- function(df) {
  tryCatch({
    # Fit nonlinear model using nls
    fit <- nls(Q_NH4_avg ~ a * Ammonium_moles_eq_avg + b,
               data = df,
               start = list(a = 1, b = 0),  # Initial parameter guesses
               na.action = na.exclude)  # Exclude rows with missing values
    
    # Return the fitted parameters
    coef(fit)
  }, error = function(e) {
    message("Error fitting nonlinear model: ", e$message)
    return(NA)  # Return NA if fitting fails
  })
}
```

## Temkin Isotherm

### Temkin Formula

```{r}

# Function to fit Freundlich isotherm using PUPAIM and extract Q_400
fit_Temkin_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    T <- 298 #K
    
    # Fit Freundlich isotherm using PUPAIM
    Temkin_fit <- temkinanalysis(C, Q, T)
    
    # Extract parameters from the fitted model
    #Kf <- BET_fit$plot_env$pars_KF
   # n <- BET_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    #C_target <- 400
    #Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    #df$Q_400 <- Q_400
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = Temkin_fit)
  }, error = function(e) {
    message("Error fitting BET model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}
```

### Temkin Fit

```{r}

ALL_Biochars_Temkin <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_Temkin_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

ALL_Biochars_Qsd_25_Q_3_Temkin <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_Temkin_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

```

### 

### 

## BET Isotherm

### BET Formula

```{r}

# Function to fit Freundlich isotherm using PUPAIM and extract Q_400
fit_BET_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Freundlich isotherm using PUPAIM
    BET_fit <- BETanalysis(C, Q)
    
    # Extract parameters from the fitted model
    #Kf <- BET_fit$plot_env$pars_KF
   # n <- BET_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    #C_target <- 400
    #Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    #df$Q_400 <- Q_400
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = BET_fit)
  }, error = function(e) {
    message("Error fitting BET model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}

```

### BET Fit

```{r}

ALL_Biochars_BET <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_BET_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

```{r}

ALL_Biochars_Qsd_25_High_C_diff_BET  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_BET_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

## Dubinin-Radushkevich Isotherm

### Dubinin-Radushkevich Formula

```{r}

# Function to fit Freundlich isotherm using PUPAIM and extract Q_400
fit_DR_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    T <- 298 #K
    
    # Fit Freundlich isotherm using PUPAIM
    DR_fit <- dubininradushkevichanalysis(C, Q, T)
    
    # Extract parameters from the fitted model
    #Kf <- BET_fit$plot_env$pars_KF
   # n <- BET_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    #C_target <- 400
    #Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    #df$Q_400 <- Q_400
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = DR_fit)
  }, error = function(e) {
    message("Error fitting BET model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}

```

### Dubinin-Radushkevich Fit

```{r}

ALL_Biochars_DR <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_DR_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

```{r}

ALL_Biochars_Qsd_25_High_C_diff_DR  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_DR_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

## Elovich Isotherm

### Elovich Formula

```{r}

# Define the Elovich fitting function with plotting and Q_400 calculation
fit_Elovich_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Elovich isotherm using PUPAIM
    elovich_fit <- elovichanalysis(C, Q)
    
    # Extract parameters from the fitted model
    KE <- elovich_fit$plot_env$pars_KE
    QmE <- elovich_fit$plot_env$pars_QmE
    
    # Calculate Q at C = 400 using the Elovich equation: Q = C / (QmE * KE * exp(-C/QmE))
    C_target <- 300
    Q_400 <- C_target / (QmE * KE * exp(-C_target / QmE))
    
    # Create a new column with Q_400 value repeated for each row
    df$Q_400 <- Q_400
    
    # Create a plot
    df$Predicted <- C / (QmE * KE * exp(-C / QmE))
    p <- ggplot(df, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg)) +
      geom_point() +
      geom_line(aes(y = Predicted), color = "blue") +
      labs(title = paste("Elovich Fit for Type_ox =", unique(df$Type_ox)),
           x = "Ammonium_moles_eq_avg",
           y = "Q_NH4_avg") +
      theme_minimal()
    
    # Print the plot
    print(p)
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = p)
  }, error = function(e) {
    message("Error fitting Elovich model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}
```

### Elovich Fit

```{r}

ALL_Biochars_Elovich <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_Elovich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

```{r}

ALL_Biochars_Qsd_25_High_C_diff_Elovich  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_Elovich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup() 
```

```{r}

ALL_Biochars_Qsd_25_Q_3_Elovich  <- ALL_Biochars_Qsd_25_Q_3 %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_Elovich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

### \*\* Dose Q-Plot Elovich Q \< 3, Qsd \<25% No AL

```{r}

ALL_Biochars_Qsd_25_Q_3_Elovich_No_AL <- ALL_Biochars_Qsd_25_Q_3_Elovich %>% filter (Type != c("AL"))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Elovich_No_AL, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Q_3_Elovich_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### 

## Non-Linear Fit

```{r}
# Load the required libraries
library(minpack.lm)

# Define the nonlinear fitting function with plotting and Q_400 calculation
fit_nonlinear <- function(df) {
  tryCatch({
    # Define ranges for initial parameter guesses
    a_range <- seq(0.05, 6, by = 0.1)  # Adjust the range as needed
    b_range <- seq(0.5, 2, by = 0.1)  # Adjust the range as needed
    
    # Iterate over the ranges and fit the model with each combination of initial guesses
    for (a_guess in a_range) {
      for (b_guess in b_range) {
        fit <- try(nlsLM(Q_NH4_avg ~ a * (Ammonium_moles_eq_avg ^ (1/b)),
                         data = df,
                         start = list(a = a_guess, b = b_guess),
                         na.action = na.exclude,
                         control = nls.lm.control(maxiter = 100, ftol = 1e-10)))
        if (!inherits(fit, "try-error")) {
          # Print summary of the fit
          print(summary(fit))
          
          # Calculate Q_NH4_avg at Ammonium_moles_eq_avg of 400
          C_target <- 300
          a <- coef(fit)["a"]
          b <- coef(fit)["b"]
          Q_400 <- a * (C_target ^ (1/b))
          
         # Create a plot
          df$Predicted <- predict(fit)
          df$Q_400 <- Q_400
          p <- ggplot(df, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg)) +
            geom_point() +
            geom_line(aes(y = Predicted), color = "blue") +
            labs(title = paste("Nonlinear Fit for Type_ox =", unique(df$Type_ox)),
                 x = "Ammonium_moles_eq_avg",
                 y = "Q_NH4_avg") +
            theme_minimal()
          
          # Print the plot
          print(p)
          
          return(df)
        }
      }
    }
    # If none of the combinations converge, return NA
    message("Failed to converge with all initial guesses.")
    df$Q_400 <- NA
    return(df)
  }, error = function(e) {
    message("Error fitting nonlinear model: ", e$message)
    df$Q_400 <- NA
    return(df)
  })
}
```

### Non-linear fit

```{r}

# Apply the function to each group
ALL_Biochars_Qsd_25_High_C_diff_nls <- ALL_Biochars_Qsd_25_High_C_diff %>%
  group_by(Type_ox) %>%
  do(fit_nonlinear(.)) %>%
  ungroup()

```

```{r}

ALL_Biochars_Qsd_25_Q_3_nls <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(fit_nonlinear(.)) %>%
  ungroup()
```

### Non-Linear plots

```{r}
ALL_Biochars_Qsd_25_Q_3_nls <- ALL_Biochars_Qsd_25_Q_3_nls %>% filter(Type != "AL")
```

```{r}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_nls, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Q_3_nls)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)


```

```{r}
ALL_Biochars_Qsd_25_Q_3_nls_XPS <- ALL_Biochars_Qsd_25_Q_3_nls %>% 
    filter(Type != "AL" & !is.na(XPS_OC) & !is.na(Q_400))

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_nls_XPS, aes(x = XPS_OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ XPS_OC, data = ALL_Biochars_Qsd_25_Q_3_nls_XPS)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)


```

```{r}


# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_nls, aes(x = net_app_H_diff_avg_abs, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ net_app_H_diff_avg_abs, data = ALL_Biochars_Qsd_25_Q_3_nls)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)
```

## Comparing all isotherms

### Comparing Isotherns with 0

### Manual Freundlich for Dose

```{r}

# Building the Freundlich isotherm nonlinear form
freundlichanalysis <- function(Ce, Qe){
  x <- Ce
  y <- Qe
  data <- data.frame(x, y)

  # Freundlich isotherm nonlinear equation
  fit1 <- y ~ (KF * (x^(1 / n)))

  # Setting of starting values
  start1 <- data.frame(KF = c(0.001, 10), n = c(0.001, 10))

  # Fitting of Freundlich isotherm via nls2
  fit2 <- nls2::nls2(fit1, start = start1, data = data,
                     control = nls.control(maxiter = 45, warnOnly = TRUE),
                     algorithm = "port")
  
  

  print("Freundlich Isotherm Analysis")
  print(summary(fit2))

  print("Akaike Information Criterion")
  print(AIC(fit2))

  print("Bayesian Information Criterion")
  BIC <- BIC(fit2)
  print(BIC)

  # Error analysis of the Freundlich isotherm model
  errors <- function(y){
    rmse <- Metrics::rmse(y, predict(fit2))
    mae <- Metrics::mae(y, predict(fit2))
    mse <- Metrics::mse(y, predict(fit2))
    rae <- Metrics::rae(y, predict(fit2))
    N <- nrow(na.omit(data))
    SE <- sqrt((sum(y - predict(fit2))^2) / (N - 2))
    list("Root Mean Squared Error" = rmse,
         "Mean Absolute Error" = mae,
         "Mean Squared Error" = mse,
         "Root Absolute Error" = rae,
         "Standard Error for the Regression S" = SE)
  }
  a <- errors(y)
  print(a)

  rsqq <- lm(Qe ~ predict(fit2))
  rsq_summary <- summary(rsqq)
  print(rsq_summary)

  adj_r_squared <- rsq_summary$adj.r.squared
  print(paste("Adjusted R-squared: ", adj_r_squared))

  # Graphical representation of the Freundlich isotherm model
  ### Predicted parameter values
  parsFreundlich <- as.vector(coefficients(fit2))
  pars_KF <- parsFreundlich[1L]
  pars_n <- parsFreundlich[2L]

  rhs <- function(x){(pars_KF * (x^(1 / pars_n)))}

  #### Plot details
  ggplot2::theme_set(ggplot2::theme_bw(10))
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = x, y = y)) +
    ggplot2::geom_point(color = "#3498DB") +
    ggplot2::geom_function(color = "#D35400", fun = rhs) +
    ggplot2::labs(x = "Ce",
                  y = "Qe",
                  title = "Freundlich Isotherm Nonlinear Model",
                  caption = "PUPAIM") +
    ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5))

  return(list(adj_r_squared = adj_r_squared, plot = plot))
}

# Function to extract adjusted R-squared values for Freundlich
fit_freundlich_pupaim <- function(df) {
  C <- c(0.001, df$Ammonium_moles_eq_avg)
  Q <- c(0.001, df$Q_NH4_avg)
  
  # Capture the output of freundlichanalysis
  result <- freundlichanalysis(C, Q)
  
  # Return a named list
  return(list(Freundlich_adj_r2 = result$adj_r_squared, Freundlich_plot = result$plot))
}

# Apply the Freundlich function to each group
adjusted_r2_freundlich_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_freundlich_pupaim(.)) %>%
  mutate(Freundlich_adj_r2 = result$Freundlich_adj_r2, Freundlich_plot = list(result$Freundlich_plot)) %>%
  select(-result)

# Print the adjusted R-squared values
print(adjusted_r2_freundlich_df)

# To display the plots for each group, you can use the following:
plots <- adjusted_r2_freundlich_df$Freundlich_plot
for (plot in plots) {
  print(plot)
}

```

### Manual Langmuir for Dose

```{r}

# Building the Langmuir isotherm nonlinear form
langmuiranalysis <- function(Ce, Qe) {
  x <- Ce
  y <- Qe
  data <- data.frame(x, y)

  # Langmuir isotherm nonlinear equation
  fit1 <- y ~ (Qmax * Kl * x) / (1 + (Kl * x))

  # Setting of starting values
  N <- nrow(na.omit(data))
  start1 <- data.frame(Qmax = seq(0.1, 30, length.out = 10),
                       Kl = seq(0.001, 0.1, length.out = 10))

  # Fitting of the Langmuir isotherm via nls2
  suppressWarnings(fit2 <- nls2::nls2(fit1, start = start1, data = data,
                                      control = nls.control(maxiter = 50, warnOnly = TRUE),
                                      algorithm = "port"))

  print("Langmuir Isotherm Nonlinear Analysis")
  print(summary(fit2))

  print("Akaike Information Criterion")
  print(AIC(fit2))

  print("Bayesian Information Criterion")
  print(BIC(fit2))

  # Error analysis of the Langmuir isotherm model
  errors <- function(y) {
    rmse <- Metrics::rmse(y, predict(fit2))
    mae <- Metrics::mae(y, predict(fit2))
    mse <- Metrics::mse(y, predict(fit2))
    rae <- Metrics::rae(y, predict(fit2))
    SE <- sqrt((sum(y - predict(fit2))^2) / (N - 2))
    list("Root Mean Squared Error" = rmse,
         "Mean Absolute Error" = mae,
         "Mean Squared Error" = mse,
         "Relative Absolute Error" = rae,
         "Standard Error for the Regression S" = SE)
  }
  a <- errors(y)
  print(a)

  rsqq <- lm(Qe ~ predict(fit2))
  rsq_summary <- summary(rsqq)
  print(rsq_summary)

  adj_r_squared <- rsq_summary$adj.r.squared
  print(paste("Adjusted R-squared: ", adj_r_squared))

  # Graphical representation of the Langmuir isotherm model
  ### Predicted parameter values
  parslang <- as.vector(coefficients(fit2))
  pars_Kl <- parslang[2L]
  pars_Qmax <- parslang[1L]

  rhs <- function(x) {((pars_Qmax * pars_Kl * x) / (1 + (pars_Kl * x)))}

  #### Plot details
  ggplot2::theme_set(ggplot2::theme_bw(10))
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = x, y = y)) +
    ggplot2::geom_point(color = "#3498DB") +
    ggplot2::geom_function(color = "#D35400", fun = rhs) +
    ggplot2::labs(x = "Ce",
                  y = "Qe",
                  title = "Langmuir Isotherm Nonlinear Model",
                  caption = "PUPAIM") +
    ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5))

  return(list(adj_r_squared = adj_r_squared, plot = plot))
}

fit_langmuir_pupaim <- function(df) {
  # Prepare data for PUPAIM
  C <- c(0, df$Ammonium_moles_eq_avg)
  Q <- c(0, df$Q_NH4_avg)
  
  # Capture the output of langmuiranalysis
  result <- langmuiranalysis(C, Q)
  
  # Return a named list
  return(list(Langmuir_adj_r2 = result$adj_r_squared, Langmuir_plot = result$plot))
}

# Apply the Langmuir function to each group
adjusted_r2_langmuir_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_langmuir_pupaim(.)) %>%
  mutate(Langmuir_adj_r2 = result$Langmuir_adj_r2, Langmuir_plot = list(result$Langmuir_plot)) %>%
  select(-result)

# Print the adjusted R-squared values
print(adjusted_r2_langmuir_df)

# To display the plots for each group, you can use the following:
plots <- adjusted_r2_langmuir_df$Langmuir_plot
for (plot in plots) {
  print(plot)
}

```

### Manual Tempkin for Dose

```{r}

# Building the Temkin isotherm nonlinear form
temkinanalysis <- function(Ce, Qe, Temp){
  x <- Ce
  y <- Qe
  t <- Temp
  R <- 8.314
  data <- data.frame(x, y)

  # Temkin isotherm nonlinear equation
  fit1 <- y ~ ((R * t) / bT) * log(AT * x)

  # Setting of starting values
  start1 <- list(AT = 0.1, bT = 0.1)  # Adjusted starting values

  # Fitting of the Temkin isotherm via nls
  fit2 <- nls(fit1, start = start1, data = data,
              control = nls.control(maxiter = 300, warnOnly = TRUE))

  print("Temkin Isotherm Nonlinear Analysis")
  print(summary(fit2))

  print("Akaike Information Criterion")
  print(AIC(fit2))

  BIC <- BIC(fit2)
  print("Bayesian Information Criterion")
  print(BIC)

  # Error analysis of the Temkin isotherm model
  errors <- function(y) {
    rmse <- Metrics::rmse(y, predict(fit2))
    mae <- Metrics::mae(y, predict(fit2))
    mse <- Metrics::mse(y, predict(fit2))
    rae <- Metrics::rae(y, predict(fit2))
    N <- nrow(na.omit(data))
    SE <- sqrt((sum(y - predict(fit2))^2) / (N - 2))
    list("Root Mean Squared Error" = rmse,
         "Mean Absolute Error" = mae,
         "Mean Squared Error" = mse,
         "Relative Absolute Error" = rae,
         "Standard Error for the Regression S" = SE)
  }
  a <- errors(y)
  print(a)
  
  rsqq <- lm(Qe ~ predict(fit2))
  rsq_summary <- summary(rsqq)
  print(rsq_summary)

  adj_r_squared <- rsq_summary$adj.r.squared
  print(paste("Adjusted R-squared: ", adj_r_squared))

  # Graphical representation of the Temkin isotherm model
  ### Predicted parameter values
  parstem <- as.vector(coefficients(fit2))
  pars_AT <- parstem[1L]
  pars_bT <- parstem[2L]

  rhs <- function(x){(((R * t) / pars_bT) * log(pars_AT * x))}

  #### Plot details
  ggplot2::theme_set(ggplot2::theme_bw(10))
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = x, y = y)) +
    ggplot2::geom_point(color = "#3498DB") +
    ggplot2::geom_function(color = "#D35400", fun = rhs) +
    ggplot2::labs(x = "Ce",
                  y = "Qe",
                  title = "Temkin Isotherm Nonlinear Model",
                  caption = "PUPAIM") +
    ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5))

  return(list(adj_r_squared = adj_r_squared, plot = plot))
}

# Function to extract adjusted R-squared values for Temkin
fit_Temkin_pupaim <- function(df) {
  C <- c(0.001,df$Ammonium_moles_eq_avg)
  Q <- c(0.001,df$Q_NH4_avg)
  T <- 298 # K
  
  # Capture the output of temkinanalysis
  result <- temkinanalysis(C, Q, T)
  
  # Return a named list
  return(list(Temkin_adj_r2 = result$adj_r_squared, Temkin_plot = result$plot))
}

# Apply the Temkin function to each group
adjusted_r2_temkin_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_Temkin_pupaim(.)) %>%
  mutate(Temkin_adj_r2 = result$Temkin_adj_r2, Temkin_plot = list(result$Temkin_plot)) %>%
  select(-result)

# Print the adjusted R-squared values
print(adjusted_r2_temkin_df)

# To display the plots for each group, you can use the following:
plots <- adjusted_r2_temkin_df$Temkin_plot
for (plot in plots) {
  print(plot)
}

```

### Manual DR for Dose

```{r}

# Dubinin-Radushkevich isotherm analysis function
dubininradushkevichanalysis <- function(Ce, Qe, Temp){
  x <- Ce
  y <- Qe
  R <- 8.314
  t <- Temp
  epsilon <- R * t * log(1 + (1 / x))
  data <- data.frame(x, y)

  ### Dubinin-Radushkevich isotherm nonlinear equation
  fit1 <- y ~ qs * exp(-K * (epsilon^2))

  ### Setting of starting values
  start1 <- list(qs = 1, K = 1e-8)

  ### Fitting of the Dubinin-Radushkevich isotherm via nls
  fit2 <- nls(fit1, start = start1, data = data,
              control = nls.control(maxiter = 300, warnOnly = TRUE))

  print("Dubinin-Radushkevich Isotherm Nonlinear Analysis")
  print(summary(fit2))

  print("Akaike Information Criterion")
  print(AIC(fit2))

  print("Bayesian Information Criterion")
  BIC <- BIC(fit2)
  print(BIC)

  # Error analysis of the Dubinin-Radushkevich isotherm model
  errors <- function(y) {
    rmse <- Metrics::rmse(y, predict(fit2))
    mae <- Metrics::mae(y, predict(fit2))
    mse <- Metrics::mse(y, predict(fit2))
    rae <- Metrics::rae(y, predict(fit2))
    N <- nrow(na.omit(data))
    SE <- sqrt((sum(y - predict(fit2))^2) / (N - 2))
    list("Root Mean Squared Error" = rmse,
         "Mean Absolute Error" = mae,
         "Mean Squared Error" = mse,
         "Relative Absolute Error" = rae,
         "Standard Error for the Regression S" = SE)
  }
  a <- errors(y)
  print(a)

  rsqq <- lm(Qe ~ predict(fit2))
  rsq_summary <- summary(rsqq)
  print(rsq_summary)

  adj_r_squared <- rsq_summary$adj.r.squared
  print(paste("Adjusted R-squared: ", adj_r_squared))

  # Graphical representation of the Dubinin-Radushkevich isotherm model
  ### Predicted parameter values
  parsdubR <- as.vector(coefficients(fit2))
  pars_qs <- parsdubR[1L]
  pars_K <- parsdubR[2L]

  rhs <- function(x) {pars_qs * exp(-pars_K * (R * t * log(1 + (1 / x)))^2)}

  #### Plot details
  ggplot2::theme_set(ggplot2::theme_bw(10))
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = x, y = y)) +
    ggplot2::geom_point(color = "#3498DB") +
    ggplot2::geom_function(color = "#D35400", fun = rhs) +
    ggplot2::labs(x = "Ce",
                  y = "Qe",
                  title = "Dubinin-Radushkevich Isotherm Nonlinear Model",
                  caption = "PUPAIM") +
    ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5))

  return(list(adj_r_squared = adj_r_squared, plot = plot))
}
# Function to extract adjusted R-squared values for DR
fit_DR_pupaim <- function(df) {
  C <- c(1, df$Ammonium_moles_eq_avg)
  Q <- c(0, df$Q_NH4_avg)
  T <- 298 # K
  
  # Capture the output of Dubinin-Radushkevich isotherm analysis
  result <- dubininradushkevichanalysis(C, Q, T)
  
  # Return as data frame
  data.frame(Type_ox = unique(df$Type_ox), DR_adj_r2 = result$adj_r_squared, DR_plot = I(list(result$plot)))
}

# Apply the DR function to each group and combine the results
adjusted_r2_DR_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(fit_DR_pupaim(.)) %>%
  ungroup()

# Display the plots for each group
plots <- adjusted_r2_DR_df$DR_plot
for (plot in plots) {
  print(plot)
}

```

### Manual Elovich for Dose

```{r}

# Building the Elovich isotherm nonlinear form
elovichanalysis <- function(Ce, Qe){
  x <- Qe
  y <- Ce
  data <- data.frame(x, y)

  # Elovich isotherm nonlinear equation
  fit1 <- y ~ x / (QmE * KE * exp(-x / QmE))

  # Setting of starting values with reasonable ranges
  start1 <- data.frame(KE = seq(0.1, 10, length.out = 10), QmE = seq(0.1, 10, length.out = 10))

  # Fitting of Elovich isotherm via nls2
  fit2 <- nls2::nls2(fit1, start = start1, data = data,
                     control = nls.control(maxiter = 100, warnOnly = TRUE),
                     algorithm = "port")

  print("Elovich Isotherm Nonlinear Analysis")
  print(summary(fit2))

  print("Akaike Information Criterion")
  print(AIC(fit2))

  print("Bayesian Information Criterion")
  BIC <- BIC(fit2)
  print(BIC)

  # Error analysis of the Elovich isotherm model
  errors <- function(y) {
    rmse <- Metrics::rmse(y, predict(fit2))
    mae <- Metrics::mae(y, predict(fit2))
    mse <- Metrics::mse(y, predict(fit2))
    rae <- Metrics::rae(y, predict(fit2))
    N <- nrow(na.omit(data))
    SE <- sqrt((sum(y - predict(fit2))^2) / (N - 2))
    list("Root Mean Squared Error" = rmse,
         "Mean Absolute Error" = mae,
         "Mean Squared Error" = mse,
         "Relative Absolute Error" = rae,
         "Standard Error for the Regression S" = SE)
  }
  a <- errors(y)
  print(a)

  rsqq <- lm(Qe ~ predict(fit2))
  rsq_summary <- summary(rsqq)
  print(rsq_summary)

  adj_r_squared <- rsq_summary$adj.r.squared
  print(paste("Adjusted R-squared: ", adj_r_squared))

  # Graphical representation of the Elovich isotherm model
  ### Predicted parameter values
  parsElovich <- as.vector(coefficients(fit2))
  pars_KE <- parsElovich[1L]
  pars_QmE <- parsElovich[2L]

  rhs <- function(x){x / (pars_QmE * pars_KE * exp(-x / pars_QmE))}

  #### Plot details
  ggplot2::theme_set(ggplot2::theme_bw(10))
  plot <- ggplot2::ggplot(data, ggplot2::aes(x = x, y = y)) +
    ggplot2::geom_point(color = "#3498DB") +
    ggplot2::geom_function(color = "#D35400", fun = rhs) +
    ggplot2::labs(x = "Qe",
                  y = "Ce",
                  title = "Elovich Isotherm Nonlinear Model",
                  caption = "PUPAIM") +
    ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5)) +
    ggplot2::coord_flip()

  return(list(adj_r_squared = adj_r_squared, plot = plot))
}

# Function to extract adjusted R-squared values for Elovich
fit_elovich_pupaim <- function(df) {
  C <- c(0.001, df$Ammonium_moles_eq_avg)
  Q <- c(0.001, df$Q_NH4_avg)
  
  # Capture the output of elovichanalysis
  result <- elovichanalysis(C, Q)
  
  # Return a named list
  return(list(Elovich_adj_r2 = result$adj_r_squared, Elovich_plot = result$plot))
}

# Apply the Elovich function to each group
adjusted_r2_elovich_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_elovich_pupaim(.)) %>%
  mutate(Elovich_adj_r2 = result$Elovich_adj_r2, Elovich_plot = list(result$Elovich_plot)) %>%
  select(-result)

# Print the adjusted R-squared values
print(adjusted_r2_elovich_df)

# To display the plots for each group, you can use the following:
plots <- adjusted_r2_elovich_df$Elovich_plot
for (plot in plots) {
  print(plot)
}

```

### Combining R2

```{r}

adjusted_r2_combined_w_0 <- adjusted_r2_temkin_df %>%
  left_join(adjusted_r2_freundlich_df, by = "Type_ox") %>%
  left_join(adjusted_r2_langmuir_df, by = "Type_ox") %>%
  left_join(adjusted_r2_DR_df, by = "Type_ox") %>%
  left_join(adjusted_r2_elovich_df, by = "Type_ox")

adjusted_r2_combined_w_0  <- adjusted_r2_combined_w_0 %>%
  select(-contains("plot"))

write_csv(adjusted_r2_combined_w_0, "adj_r2_dose.csv")

summary(adjusted_r2_combined_w_0)
```

### Freundlich Dose w/ 0

```{r}


# Building the Freundlich isotherm nonlinear form
freundlichanalysis <- function(Ce, Qe){
  x <- Ce
  y <- Qe
  data <- data.frame(x, y)

  # Freundlich isotherm nonlinear equation
  fit1 <- y ~ (KF * (x^(1 / n)))

  # Setting of starting values
  start1 <- data.frame(KF = c(0.001, 10), n = c(0.001, 10))

  # Fitting of Freundlich isotherm via nls2
  fit2 <- nls2::nls2(fit1, start = start1, data = data,
                     control = nls.control(maxiter = 45, warnOnly = TRUE),
                     algorithm = "port")

  print("Freundlich Isotherm Analysis")
  print(summary(fit2))

  print("Akaike Information Criterion")
  print(AIC(fit2))

  print("Bayesian Information Criterion")
  BIC <- BIC(fit2)
  print(BIC)

  # Extract parameters from the fitted model
  parsFreundlich <- as.vector(coefficients(fit2))
  pars_KF <- parsFreundlich[1L]
  pars_n <- parsFreundlich[2L]

  # Calculate Q at C = 300 using the Freundlich equation: Q = Kf * C^(1/n)
  C_target <- 300
  Q_300 <- pars_KF * C_target^(1 / pars_n)

  return(list(Q_300 = Q_300))
}

# Function to extract Q at C = 300 for Freundlich
fit_freundlich_pupaim <- function(df) {
  C <- c(0.001, df$Ammonium_moles_eq_avg)
  Q <- c(0.001, df$Q_NH4_avg)
  
  # Capture the output of freundlichanalysis
  result <- freundlichanalysis(C, Q)
  
  # Return a named list
  return(list(Q_300 = result$Q_300))
}

# Apply the Freundlich function to each group
Freund_w_0 <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_freundlich_pupaim(.)) %>%
  mutate(Q_300 = result$Q_300) %>%
  select(-result)

# Merge the Q_300 values into the existing dataframe
Freund_w_0_df <- Freund_w_0 %>%
  left_join(ALL_Biochars_Qsd_25_Q_3, by = "Type_ox")

```

### Freunlich Dose Plots

```{r}
Freund_w_0_df <- Freund_w_0_df %>%
  distinct(Type_ox, .keep_all = TRUE)
```

```{r}

# Filter out missing or non-finite values
Freund_w_0_df_No_AL <- Freund_w_0_df %>% 
  filter(Type != "AL" & !is.na(XPS_OC) & !is.na(Q_300))
```

### \*\* Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(Freund_w_0_df_No_AL, aes(x = OC, y = Q_300, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_300 ~ OC, data = Freund_w_0_df_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_300), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\*Q-Plot Freundlich Q \< 3, Qsd \<25%, No AL - OC_XPS

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(Freund_w_0_df_No_AL, aes(x = XPS_OC, y = Q_300, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Surface") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_300 ~ XPS_OC, data = Freund_w_0_df_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Q_300), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\*Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL Net App Diff

```{r, warning=FALSE}

Qmax_Plot <- ggplot(Freund_w_0_df_No_AL, aes(x = net_app_H_diff_avg_abs, y = Q_300, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_300 ~ net_app_H_diff_avg_abs, data = Freund_w_0_df_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Q_300), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)
```

### \*\*\*Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL - Carb only no outlier

```{r}

Freund_w_0_df_No_AL_Carb <- Freund_w_0_df_No_AL %>%
  mutate(Carb_ksp = Carb + KsP) %>%
  filter (Carb_pi_Ksp <= 0.24)

```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(Freund_w_0_df_No_AL_Carb, aes(x = Carb_ksp, y = Q_300, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("C=O)-O") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_300 ~ Carb_ksp, data = Freund_w_0_df_No_AL_Carb)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(Carb_ksp), y = max(Q_300), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\*\* Freundlich Dose Plot

```{r}

# Building the Freundlich isotherm nonlinear form
freundlichanalysis <- function(Ce, Qe){
  x <- Ce
  y <- Qe
  data <- data.frame(x, y)

  # Freundlich isotherm nonlinear equation
  fit1 <- y ~ (KF * (x^(1/n)))

  # Setting of starting values
  start1 <- data.frame(KF = c(0.001, 10), n = c(0.001, 10))

  # Fitting of Freundlich isotherm via nls2
  fit2 <- nls2::nls2(fit1, start = start1, data = data,
                     control = nls.control(maxiter = 45, warnOnly = TRUE),
                     algorithm = "port")

  print("Freundlich Isotherm Analysis")
  print(summary(fit2))

  print("Akaike Information Criterion")
  print(AIC(fit2))

  print("Bayesian Information Criterion")
  BIC <- BIC(fit2)
  print(BIC)

  # Extract fitted values from the model
  fitted_values <- predict(fit2, newdata = data)

  # Extract parameters from the fitted model
  parsFreundlich <- as.vector(coefficients(fit2))
  pars_KF <- parsFreundlich[1L]
  pars_n <- parsFreundlich[2L]

  # Calculate Q at C = 300 using the Freundlich equation: Q = Kf * C^(1/n)
  C_target <- 300
  Q_300 <- pars_KF * C_target^(1 / pars_n)

  return(list(Q_300 = Q_300, fitted_values = fitted_values))
}

# Function to extract fitted values for Freundlich
fit_freundlich_pupaim <- function(df) {
  C <- c(0.001, df$Ammonium_moles_eq_avg)
  Q <- c(0.001, df$Q_NH4_avg)
  
  # Capture the output of freundlichanalysis
  result <- freundlichanalysis(C, Q)
  
  # Remove the first element to match the length of the original data
  df$fitted_values <- result$fitted_values[-1]
  
  # Return the dataframe with fitted values
  return(df)
}

# Apply the Freundlich function to each group and add fitted values
ALL_Biochars_Qsd_25_Q_3_freund_fit <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  group_modify(~ fit_freundlich_pupaim(.))

# Plot the data with fitted values
Q_Conc_Dose_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_freund_fit, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, border = OC, fill = OC, na.rm = TRUE)) +
  geom_point(shape = 24, size = 6, stroke = 2, color = "black") +
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  geom_line(aes(y = fitted_values, group = Type_ox), size = 1.2, linetype = "solid") + # Add  isotherm line for each sample
  facet_wrap(~ Type_ox, scales = "fixed") +
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.direction = "horizontal",
    legend.key.width = unit(0.8, "cm"),  # Make legend wider
    legend.key.height = unit(0.2, "cm"),  # Make legend thinner
    legend.position = c(0.9, -0.1),
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none")

# Print the updated plot
print(Q_Conc_Dose_Plot)



```

### \*\*\* Correlation Matrix

```{r, warning=FALSE}

ALL_Biochars_Qsd_25_Q_3__No_AL_corr <- ALL_Biochars_Qsd_25_Q_3_No_AL %>%
  select("Type_ox", "OC", "XPS_OC","net_app_H_diff_avg_abs", "O", "CH", "C_O", "Carb", "pi_pi", "KsP", "Carb_pi_Ksp") %>%
  mutate(Carb_pi = Carb + pi_pi) %>%
  mutate(Carb_ksp = Carb + KsP) %>%
  mutate(Carb_pi_Ksp_dec = ifelse(Carb_pi_Ksp > 0.24, NA, Carb_pi_Ksp)) %>%
  mutate(Carb_pi_dec = ifelse(Carb_pi > 0.24, NA, Carb_pi)) %>%
  mutate(Surf_OC_low_ash = ifelse(!grepl("AO", Type_ox), XPS_OC, NA))%>%
  select(-c("pi_pi","C_O", "KsP", "O",,"Carb", "CH","Carb_pi","Carb_pi_Ksp","Carb_pi_dec","Carb_ksp"))

#"Carb_pi_Ksp_dec",

# Assuming your dataframe is ALL_Biochars_Qsd_25_Q_3_corr
chart.Correlation(ALL_Biochars_Qsd_25_Q_3__No_AL_corr[,-1], histogram=TRUE, pch=19,  method =  "spearman")

```

### Correlation matrix - Q Freunlich (no AL)

```{r, warning=FALSE}

Freund_w_0_df_No_ALeund_w_0_df_corr <- Freund_w_0_df_No_AL %>%
  select("Type_ox","Q_300", "OC", "XPS_OC", "O", "CH", "C_O", "Carb", "pi_pi", "KsP", "Carb_pi_Ksp", "net_app_H_diff_avg_abs") %>%
  mutate(Carb_pi = Carb + pi_pi) %>%
  mutate(Carb_ksp = Carb + KsP) %>%
  mutate(Carb_ksp_dec = ifelse(Carb_ksp > 0.16, NA, Carb_ksp)) %>%
  mutate(Carb_pi_Ksp_dec = ifelse(Carb_pi_Ksp > 0.24, NA, Carb_pi_Ksp)) %>%
  mutate(Carb_pi_dec = ifelse(Carb_pi > 0.24, NA, Carb_pi)) %>%
  mutate(Surf_OC_low_ash = ifelse(!grepl("AO", Type_ox), XPS_OC, NA)) %>%
  select(-c("pi_pi","C_O", "KsP", "O", "CH","Carb","Carb_pi_Ksp","Carb_pi_Ksp_dec","Carb_pi_dec","Carb_pi"))

#"Carb_pi_dec","Carb_pi_Ksp_dec","Carb",

# Assuming your dataframe is ALL_Biochars_Qsd_25_Q_3_corr
chart.Correlation(Freund_w_0_df_corr[,-1], histogram=TRUE, pch=19,  method =  "spearman")
```
