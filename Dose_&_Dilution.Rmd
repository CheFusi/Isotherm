---
title: "Dilution_and_Dose"
output: html_document
date: "2024-04-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries

```{r, message=FALSE}

libs_1<-c("tidyverse","knitr","psych","reshape2","rmarkdown")

#data manipulation/exploration
libs_2<-c("readxl","readr","tidyr","GGally","naniar","PUPAIM", "purrr")
# plotting
libs_3<-c("ggplot2","viridis","ggpubr","cowplot", "gridExtra")#,"ggthemr") 

#ggpubr = package for publishing
#cowplot=  #to create compounded figures

#tables
libs_4<-c("dplyr","stargazer","xlsx","ggplot2","scales","extrafont","writexl")

libs <- c(libs_1, libs_2, libs_3, libs_4)

# Suppress output unless there's an error
invisible(lapply(libs, require, character.only = TRUE, quietly = TRUE))
```

### Combining Dose and Dilutions

```{r}

Dilution_Isotherm_All <- readRDS("Dilution_Isotherms_All.RDS")
#Dose_Isotherm_All <- readRDS("Dose_Isotherms_All.RDS")
ALL_Biochars <- readRDS("ALL_Biochars.RDS")

Titration_no_AL <- readRDS("/Users/soliverchefusi/Library/CloudStorage/OneDrive-Personal/Desktop/Fusi/Acid_Base_Titration/Titration/Titration_no_AL.RDS")

```

```{r}

# Replace the Type_ox for the additional samples (K-O) with the appropriate label "AK_31" with "AK_30" in the Type_Ox column
Dilution_Isotherm_All$AK_31$Type_ox <- gsub("AK_31", "AK_30", Dilution_Isotherm_All$AK_31$Type_ox)

Dilution_Isotherm_All$AK_06$Type_ox <- gsub("AK_06", "AK_05", Dilution_Isotherm_All$AK_06$Type_ox)

Dilution_Isotherm_All$AK_11$Type_ox <- gsub("AK_11", "AK_10", Dilution_Isotherm_All$AK_11$Type_ox)

Dilution_Isotherm_All$AM_16$Type_ox <- gsub("AM_16", "AM_15", Dilution_Isotherm_All$AM_16$Type_ox)

```

```{r}

# rbind all dataframes in the list into one dataframe
Dilution_All <- do.call(rbind, Dilution_Isotherm_All)

# Extract unique values for each "Type_ox" in ALL_Biochars
unique_biochars <- unique(ALL_Biochars[, c("Type_ox", "OC", "SSA", "Type", "XPS_OC")])

# Merge the unique values with Dilution_All based on "Type_ox"
merged_df <- merge(Dilution_All, unique_biochars, by = "Type_ox", all.x = TRUE)

# Create a new column to store the index where the Type_ox values match
Dilution_All$match_idx <- match(Dilution_All$Type_ox, merged_df$Type_ox)

# Subsetting merged_df based on match_idx to ensure proper alignment
Dilution_All$OC <- merged_df$OC[Dilution_All$match_idx]
Dilution_All$SSA <- merged_df$SSA[Dilution_All$match_idx]
Dilution_All$Type <- merged_df$Type[Dilution_All$match_idx]
Dilution_All$XPS_OC <- merged_df$XPS_OC[Dilution_All$match_idx]

#Adding in Surface Area normalized Q 

Dilution_All <- Dilution_All %>%
  mutate(Q_NH4_avg_SSA = Q_NH4_avg / SSA)

#check
Dilution_View <- merged_df %>%
  select(Type_ox, OC, XPS_OC)# Q_NH4_avg, Qmax)
# Remove the match_idx column if no longer needed
Dilution_All$match_idx <- NULL


```

```{r}

Dilution_All$OX <- as.factor(Dilution_All$OX)

# Set NaN values to NA in the column "Ammonium_moles_eq_avg"
Dilution_All$Ammonium_moles_eq_avg[is.nan(Dilution_All$Ammonium_moles_eq_avg)] <- NA

ALL_Biochars_sub <- ALL_Biochars %>% filter(Type_ox %in% c("AK_05", "AK_10", "AK_15", "AK_30", "AM_05","AM_10","AM_15", "AN_30","AO_20"))

Dilution_All_sub <- Dilution_All %>% filter(Type_ox %in% c("AK_05", "AK_10", "AK_15", "AK_30", "AM_05","AM_10","AM_15", "AN_30","AO_20"))

# Extract common column names
common_col_names <- intersect(names(Dilution_All_sub), names(ALL_Biochars_sub))

ALL_Biochars_sub_2 <- (ALL_Biochars_sub[, common_col_names])

Diliution_All_sub_2 <- (Dilution_All_sub[, common_col_names])

# Perform right join based on common column names
#Dose_Dilution <- rbind(Dilution_All_sub[, common_col_names], ALL_Biochars_sub[, common_col_names])

#colnames_df1 <- colnames(Diliution_All)
#colnames_df2 <- colnames(Dose_Diliution)

# Find the column names that are unique to each dataframe
#unique_to_df1 <- setdiff(colnames_df1, colnames_df2)
#unique_to_df2 <- setdiff(colnames_df2, colnames_df1)

#unique_to_df1

#unique_to_df2
```

#### Add in OC

```{r}

Dose_Dilution <- rbind(transform(ALL_Biochars_sub_2, Shape = "Dose"),
                       transform(Diliution_All_sub_2, Shape = "Dilution"))

# # Define the mapping
# type_ox_mapping <- c("AK_05" = "0.20", "AK_10" = "0.23", "AK_15"= "0.25", "AK_30" = "0.30", "AM_05"= "0.13","AM_10" = "0.17","AM_15" = "0.18", "AN_30" = "0.14", "AO_20" = "0.25")
# 
# type_ox_xps_mapping <- c("AK_05" = "0.18", "AK_10" = "0.18", "AK_15"= "0.19", "AK_30" = "0.23", "AM_05"= "0.12","AM_10" = "0.16","AM_15" = "0.19", "AN_30" = "0.16", "AO_20" = "0.19") #Update AK_15
# 
# # Add a new column OC based on the mapping
# Dose_Dilution <- Dose_Dilution %>%
#   mutate(OC = type_ox_mapping[Type_ox],
#          OC_XPS = type_ox_xps_mapping[Type_ox] )

Dose_Dilution <- Dose_Dilution %>% filter(Q_NH4_avg >0)# & Q_NH4_avg<5)  
Dose_Dilution$OC <- as.numeric(Dose_Dilution$OC)
```

#### Add Net App H charge Diff

```{r}


# Extract unique values for each "Type_ox" in ALL_Biochars
unique_biochars <- unique(Titration_no_AL[, c("Type_ox", "net_app_H_diff_avg_abs")])

# Merge the unique values with Dilution_All based on "Type_ox"
merged_df <- merge(Dose_Dilution, unique_biochars, by = "Type_ox", all.x = TRUE)
merged_df_All <- merge(ALL_Biochars, unique_biochars, by = "Type_ox", all.x = TRUE)

# Create a new column to store the index where the Type_ox values match
Dose_Dilution$match_idx <- match(Dose_Dilution$Type_ox, merged_df$Type_ox)
ALL_Biochars$match_idx <- match(ALL_Biochars$Type_ox, merged_df_All$Type_ox)

# Subsetting merged_df based on match_idx to ensure proper alignment
Dose_Dilution$net_app_H_diff_avg_abs <- merged_df$net_app_H_diff_avg_abs[Dose_Dilution$match_idx]

ALL_Biochars$net_app_H_diff_avg_abs <- merged_df_All$net_app_H_diff_avg_abs[ALL_Biochars$match_idx]

```

### Separating Dilution and Dose Data

```{r}

Dilution_Data <- Dose_Dilution %>% filter(Shape == "Dilution")

#Removing additional points from AK5, AK10, AM15 and AK30 so all Dilution biochars have 10 isotherm points 

Dilution_Data <- Dilution_Data %>% filter(!(Type_ox %in% c("AK_05", "AK_10", "AM_15") & ID %in% c(2, 4, 6)) &
                                          !(Type_ox == "AK_30" & ID %in% c(2, 4, 6, 8, 10)))


Dose_Data <- Dose_Dilution %>% filter(Shape == "Dose")
```

### Filtering Data

-   Only retaining biochars with percent standard deviation \< 25% and Q-Qsd is greater than 0

-   ALL_Biochars_Qsd_25: samples where stdev is less than 25%

-   ALL_Biochars_High_C_diff: samples where stdev is less than 25% and the difference between initial and equilibrium concentrations are greater than 90 mg/L

```{r}

ALL_Biochars <- ALL_Biochars %>%
  filter (Q_NH4_avg >= 0 & Q_NH4_avg-Q_NH4_sd >= 0) 

Dose_Dilution <- Dose_Dilution %>% 
  filter (Q_NH4_avg >= 0 & Q_NH4_avg-Q_NH4_sd >= 0)

ALL_Biochars_Qsd_25 <- ALL_Biochars %>%
  filter (Q_NH4_avg_sd_perc <=25) #%>%
  #filter(Q_NH4_avg <= 3)

ALL_Biochars_High_C_diff <- ALL_Biochars %>%
  mutate(C_diff = Ammonium_moles_in_avg - Ammonium_moles_eq_avg ) %>%
  filter(C_diff >= 90)

ALL_Biochars_Qsd_25_High_C_diff <- ALL_Biochars_Qsd_25 %>%
  mutate(C_diff = Ammonium_moles_in_avg - Ammonium_moles_eq_avg ) %>%
  filter(C_diff >= 90)

ALL_Biochars_Qsd_25_Q_3 <- ALL_Biochars %>%
  filter (Q_NH4_avg_sd_perc <=25) %>%
  filter(Q_NH4_avg <= 2.5)

Dose_Dilution_Qsd_25_Q_3 <- Dose_Dilution %>%
  filter (Q_NH4_sd/Q_NH4_avg <=0.25) %>%
  filter(Q_NH4_avg <= 2.5)
```

### View AO and AL

```{r}

AO_AL_df <- ALL_Biochars_Qsd_25_High_C_diff %>%
  filter(Type %in% c("AL", "AO")) %>%
  select(C_diff, Type_ox)

ALL_Biochars_No_AL <- ALL_Biochars %>%
  filter (!Type %in% c("AL")) 

ALL_Biochars_Qsd_25_Q_3_No_AL <- ALL_Biochars_Qsd_25_Q_3 %>%
  filter (!Type %in% c("AL"))

```

### \*\* Dilution Only Plot

```{r}

Q_Conc_Plot<- ggplot(Dilution_Data,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.83),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") 
Q_Conc_Plot
```

### Surface Area Normalized Dilution Plot

```{r}

Q_Conc_Plot<- ggplot(Dilution_Data,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg_SSA, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    #geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   #geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/m2 biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.83),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") 
Q_Conc_Plot
```

### Dose Only Plot

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

### Dose only no AL

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_No_AL,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot


```

### Dose Only No AL SSA Normialized

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_No_AL,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg_SSA, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    #geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   #geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot

```

### \*\* Dose Only Q \< 3, Qsd \< 25%

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Qsd_25_Q_3_No_AL,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 24, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

```{r}
 
Dose_low_Q <- ALL_Biochars %>% filter (OC < 0.18)

Q_Conc_Dose_Plot<- ggplot(Dose_low_Q,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

```{r}

Dose_high_Q <- ALL_Biochars %>% filter (OC > 0.22)

Q_Conc_Dose_Plot<- ggplot(Dose_high_Q,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot

```

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   #facet_wrap(~ Type_ox, scales = "free")+ ###to separate into individual plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/m2 biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") +
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  scale_y_continuous(expand = c(0,0), limits = c(-0.2,3))
Q_Conc_Dose_Plot 
```

```{r}

Q_Conc_Plot<- ggplot(Dose_Dilution,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, shape = Shape, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
    scale_shape_manual(values = c("Dose" = 16, "Dilution" = 10)) +
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Plot
```

Dose & Dilution plots

```{r, warning=FALSE}

Dose_Dilution_low_Q <- Dose_Dilution %>% filter (OC < 0.19)
Dose_Dilution_high_Q <- Dose_Dilution %>% filter (OC > 0.19)

Q_Conc_Plot<- ggplot(Dose_Dilution_low_Q,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, shape = Shape, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
   facet_wrap(~ OC, scales = "free")+ ###to separate into 3 plots
    scale_shape_manual(values = c("Dose" = 16, "Dilution" = 10)) +
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.8, 0.1),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,2))
Q_Conc_Plot
```

```{r}

Q_Conc_Plot <- ggplot(Dose_Dilution, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, border = "black", shape = Shape, fill = OC, na.rm = TRUE)) +
  geom_point(size = 6, stroke = 1) +
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  scale_shape_manual(values = c("Dose" = 15, "Dilution" = 16)) +  # Assign different shapes based on the "Shape" variable
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "bottom",  # Position the legend at the bottom
    legend.direction = "horizontal",  # Display the legend horizontally
    legend.justification = "right",  # Justify the legend to the right
    legend.box.just = "right",  # Justify the legend box to the right
    #legend.position = c(0.1, 0.7),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 18),
    legend.key.size = unit(0.7, "lines"),  # Adjust the size of the legend key
    legend.box.background = element_rect(color = "black", size = 0.9, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0, 0), limits = c(-15, 650)) +
  #scale_y_continuous(expand = c(0, 0), limits = c(-0.2, 4))

Q_Conc_Plot
```

### \*\* Combined Dose-Dilution Plot

```{r, warning= False}

Q_Conc_Plot <- ggplot(Dose_Dilution_Qsd_25_Q_3, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, shape = Shape, fill = OC)) +
  geom_point(size = 6, stroke = 2, color = "black") +  # Outline shapes with a black line
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  scale_shape_manual(values = c("Dose" = 24, "Dilution" = 21)) +  # Use shapes that support the fill and stroke aesthetics
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.3, 0.9),  # Move legend 
    legend.direction = "horizontal",  # Set legend direction to horizontal
    legend.box = "horizontal",
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 15),
    legend.key.size = unit(1.2, "lines"),  # Adjust the size of the legend key
    legend.box.background = element_rect(color = "black", size = 0.5, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none") 

Q_Conc_Plot
```

```{r, warning=FALSE}

Q_Conc_Plot <- ggplot(Dose_Dilution, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC, border = "black", shape = Shape, fill = OC, na.rm = TRUE)) +
  geom_point(size = 6, stroke = 1) +
  geom_errorbarh(aes(xmin = Ammonium_moles_eq_avg - Ammonium_moles_eq_sd, xmax = Ammonium_moles_eq_avg + Ammonium_moles_eq_sd)) +
  geom_errorbar(aes(ymin = Q_NH4_avg - Q_NH4_sd, ymax = Q_NH4_avg + Q_NH4_sd)) +
  facet_wrap(~ OC, scales = "free") +
  scale_shape_manual(values = c("Dose" = 15, "Dilution" = 16)) +  # Assign different shapes based on the "Shape" variable
  xlab("Equilibrium Concentration (mM)") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "bottom",  # Position the legend at the bottom
    legend.direction = "horizontal",  # Display the legend horizontally
    legend.justification = "right",  # Justify the legend to the right
    legend.box.just = "right",  # Justify the legend box to the right
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 18),
    legend.key.size = unit(0.9, "lines"),  # Adjust the size of the legend key
    legend.box.background = element_rect(color = "black", size = 0.9, linetype = "solid")
  ) +
  scale_fill_gradient(low = "purple", high = "yellow") +
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend()) +
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0, 0), limits = c(-15, 650)) +
  #scale_y_continuous(expand = c(0, 0), limits = c(-0.2, 3.2))

Q_Conc_Plot

```

### Dose only Plot - AO and AL

```{r}

ALL_Biochars_Only_AL_AO <- ALL_Biochars%>% filter((Type %in% c("AO", "AL")))

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Only_AL_AO,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") #+
  #scale_x_continuous(expand = c(0,0), limits = c(-15,650))+
  #scale_y_continuous(expand = c(0,0), limits = c(-0.2,4))
Q_Conc_Dose_Plot
```

```{r}

Q_Conc_Dose_Plot<- ggplot(ALL_Biochars_Only_AL_AO,aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg, color = OC,border= OC, fill=OC, na.rm=TRUE)) +
   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_errorbarh(aes(xmin=Ammonium_moles_eq_avg-Ammonium_moles_eq_sd, xmax=Ammonium_moles_eq_avg+Ammonium_moles_eq_sd))+
   geom_errorbar(aes(ymin=Q_NH4_avg-Q_NH4_sd, ymax=Q_NH4_avg+Q_NH4_sd))+
  # facet_wrap(~ Cation_Species, scales = "free")+ ###to separate into 3 plots
  xlab("Equilibrium Concentration (mM)")+
  ylab("Q (mmol NH4/g biochar)")+
  #ggtitle()+
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),  # Adjust the legend position as needed
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) +
   scale_fill_gradient(low = "purple", high = "yellow")+
  scale_color_gradient(low = "purple", high = "yellow", guide = guide_legend())+
  guides(color = "none") +
  scale_x_continuous(expand = c(0,0), limits = c(-15,600))+
  scale_y_continuous(expand = c(0,0), limits = c(-0.2,3))
Q_Conc_Dose_Plot
```

## Dilution Isotherms

### Langmuir Isotherm Manual

```{r}

# # Define the Langmuir function
# Langmuir <- function(C, Qmax, K) {
#   Qmax * K * C / (1 + (K * C))
# }
# 
# # Function to fit Langmuir isotherm and extract Qmax
# fit_langmuir <- function(df) {
#   # Fit Langmuir isotherm
#   fit <- nls(Q_NH4_avg ~ Langmuir(Ammonium_moles_eq_avg, Qmax, K),
#              data = df,
#              start = list(Qmax = max(df$Q_NH4_avg), K = 0.005),  # Initial parameter guesses
#              na.action = na.exclude,# Exclude rows with missing values
#              control = nls.control(maxiter = 1000)) #increase max number of iterations  
#   
#   # Extract Qmax value from the fit
#   Qmax <- coef(fit)["Qmax"]
#   
#   # Create a new column with Qmax value repeated for each row
#   df$Qmax <- Qmax
#   
#   return(df)
# }
# 
# Dilution_Data <- Dilution_Data %>%
#   group_by(Type_ox) %>%
#   #filter(Type_ox %in% c("AN_30")) %>%
#   mutate(Qmax = fit_langmuir(cur_data())$Qmax)  # Extract Qmax value directly
# 
# Dilution_Data$Qmax <- as.numeric(Dilution_Data$Qmax)
# #Dilution_Data$OC_XPS <- as.numeric(Dilution_Data$OC_XPS)
# 
# #langmuir_fit <- langmuiranalysis(Dilution_Isotherm_All$AN_30$Ammonium_moles_eq_avg, Dilution_Isotherm_All$AN_30$Q_NH4_avg)
# #langmuir_fit

# Define the Langmuir function
Langmuir <- function(C, Qmax, K) {
  Qmax * K * C / (1 + K * C)
}

# Function to fit Langmuir isotherm and extract Qmax
fit_langmuir <- function(df) {
  # Try a range of initial guesses to avoid singular gradient issues
  start1 <- expand.grid(Qmax = seq(0, 100, length.out = 10), K = seq(0.001, 100, length.out = 10))
  
  
  tryCatch({
    # Fit Langmuir isotherm
    fit <- nls2::nls2(Q_NH4_avg ~ Langmuir(Ammonium_moles_eq_avg, Qmax, K),
                      data = df,
                      start = start1,  # Multiple starting points
                      na.action = na.exclude, # Exclude rows with missing values
                      control = nls.control(maxiter = 50, minFactor = 1e-8),
                      algorithm = "port") # Increase max iterations and decrease minFactor
    
    # Extract Qmax value from the fit
    Qmax <- coef(fit)["Qmax"]
    
    # Create a new column with Qmax value repeated for each row
    df$Qmax <- Qmax
  }, error = function(e) {
    # Handle errors by assigning NA to Qmax and returning the dataframe
    df$Qmax <- NA
    message("Error fitting Langmuir model for Type_ox =", unique(df$Type_ox), ": ", e$message)
  })
  
  return(df)
}

Dilution_Data <- Dilution_Data %>%
  group_by(Type_ox) %>%
  do(fit_langmuir(.)) %>%
  ungroup() # Ungroup after processing

Dilution_Data$Qmax <- as.numeric(Dilution_Data$Qmax)


```

### Langmuir with R PUPAIM Package

```{r}

# Function to fit Langmuir isotherm using PUPAIM and extract Qmax
fit_langmuir_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Langmuir isotherm using PUPAIM
    langmuir_fit <- langmuiranalysis(C, Q)
    
    # Extract Qmax value from the fit
    Qmax_R <- langmuir_fit$plot_env$pars_Qmax

    
    # Create a new column with Qmax value repeated for each row
    df$Qmax_R <- Qmax_R
    
    return(df)
  }, error = function(e) {
    message("Error fitting Langmuir model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    df$Qmax_R <- NA  # Assign NA if fitting fails
    return(df)
  })
}

Dilution_Data <- Dilution_Data %>%
  #filter(Q_NH4_avg <= 3) %>%
  group_by(Type_ox) %>%
  do(fit_langmuir_pupaim(.)) %>%
  ungroup() # Ungroup after processing

# Convert Qmax to numeric
#Dilution_Data$Qmax <- as.numeric(Dilution_Data$Qmax)

#langmuir_fit_test <- langmuiranalysis(Dilution_Data$Ammonium_moles_eq_avg[c(1:13)],Dilution_Data$Q_NH4_avg[c(1:13)])
#Qmax <- langmuir_fit_test$plot_env$pars_Qmax


```

### Dilution Data - w/o Replciate OC and Qmax for s

```{r}

# Filter the data to include only unique rows based on Type_ox
unique_Dilution_data <- Dilution_Data %>% distinct(Type_ox, .keep_all = TRUE)
```

### \*\* Dilution Qmax Plot - Manual Langmuir

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data, aes(x = OC, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ OC, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Dilution Qmax Plot Bulk OC - R Langmuir

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data, aes(x = OC, y = Qmax_R, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax_R ~ OC, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\* Dilution Qmax Plot Surface OC- Manual Langmuir

```{r}

unique_Dilution_data_XPS <- unique_Dilution_data %>% filter(!is.na(XPS_OC))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data_XPS, aes(x = XPS_OC, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ XPS_OC, data = unique_Dilution_data_XPS)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\* Dilution Qmax Plot Net App H- Manual Langmuir

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data, aes(x = net_app_H_diff_avg_abs, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.7, 0.2),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ net_app_H_diff_avg_abs, data = unique_Dilution_data)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### Dilution Qmax Plot Net App H- Manual Langmuir (NO AO )

```{r}
 unique_Dilution_data_No_AO <- unique_Dilution_data %>% filter (Type != "AO")

# Create the plot with unique data
Qmax_Plot <- ggplot(unique_Dilution_data_No_AO, aes(x = net_app_H_diff_avg_abs, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.7, 0.2),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Qmax ~ net_app_H_diff_avg_abs, data = unique_Dilution_data_No_AO)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* Net_App_H\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

## Dose Isotherms

## Dose Langmuir Isotherm

### Langmuir Formula- Manual Qmax

```{r}
# 
# library(minpack.lm)
# 
# # Define the Langmuir function
# Langmuir <- function(C, Qmax, K) {
#   Qmax * K * C / (1 + K * C)
# }
# 
# # Function to fit Langmuir isotherm and extract Qmax using nlsLM
# fit_langmuir <- function(df) {
#     # Fit Langmuir isotherm using nlsLM
#     fit <- nlsLM(Q_NH4_avg ~ Langmuir(Ammonium_moles_eq_avg, Qmax, K),
#                  data = df,
#                  start = list(Qmax = max(df$Q_NH4_avg, na.rm = TRUE), K = 0.05),  # Initial parameter guesses
#                  na.action = na.exclude, # Exclude rows with missing values
#                  control = nls.lm.control(maxiter = 1000, ftol = 1e-10)) # Increase max number of iterations and set ftol
#     
#     # Extract Qmax value from the fit
#     Qmax <- coef(fit)["Qmax"]
#     
#     # Create a new column with Qmax value repeated for each row
#     df$Qmax <- Qmax
#     
#     return(df)
#   }
# 
# # Apply the function to each group
# ALL_Biochars_Qsd_25 <- ALL_Biochars_Qsd_25 %>%
#   group_by(Type_ox) %>%
#   mutate(Qmax = fit_langmuir(cur_data())$Qmax)
# 
# ALL_Biochars_Qsd_25$Qmax <- as.numeric(ALL_Biochars_Qsd_25$Qmax)
```

### Langmuir Formula (Dose) with R PUPAIM Package

```{r}

# Function to fit Langmuir isotherm using PUPAIM and extract Qmax
fit_langmuir_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Langmuir isotherm using PUPAIM
    langmuir_fit <- langmuiranalysis(C, Q)
    
    # Extract Qmax value from the fit
    Qmax_R <- langmuir_fit$plot_env$pars_Qmax
    
    # Create a new column with Qmax value repeated for each row
    df$Qmax_R <- Qmax_R
    
    # Save the plot
    plot_name <- paste0("Langmuir_Plot_", unique(df$Type_ox), ".png")
    ggsave(plot_name, plot = langmuir_fit, device = "png")
    
    # Return the plot and the modified dataframe
    list(data = df, plot = langmuir_fit)
  }, error = function(e) {
    message("Error fitting Langmuir model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    df$Qmax_R <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}
```

### Langmuir Fit- Visualizing Langmuir fits

```{r}

ALL_Biochars_Langmuir <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_langmuir_pupaim(.)
    # Display the plot
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data
  }) %>%
  ungroup() # Ungroup after processing
```

### Including 0,0 in hopes of improving the fit

```{r}

# Ensure (0,0) is included in the dataframe
add_zero_point <- function(df) {
  # Create a zero point with the same structure as df
  zero_point <- df[1, ]
  zero_point[ , ] <- NA
  zero_point$Ammonium_moles_eq_avg <- 0
  zero_point$Q_NH4_avg <- 0
  zero_point$Type_ox <- unique(df$Type_ox)
  
  # Bind the zero point to the original dataframe
  df <- rbind(df, zero_point)
  return(df)
}

```

```{r}

# Apply the function to each group and fit the Langmuir isotherm
ALL_Biochars_Langmuir_w_0 <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    df_with_zero <- add_zero_point(.)
    result <- fit_langmuir_pupaim(df_with_zero)
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data
  }) %>%
  ungroup()

```

```{r}

ALL_Biochars_Qsd_25 <- ALL_Biochars_Qsd_25 %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_langmuir_pupaim(.)
    # Display the plot
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data
  }) %>%
  ungroup() # Ungroup after processing

```

```{r}

ALL_Biochars_High_C_diff <- ALL_Biochars_High_C_diff %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_langmuir_pupaim(.)
    # Display the plot
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data
  }) %>%
  ungroup() # Ungroup after processingg
```

```{r}


ALL_Biochars_Qsd_25_High_C_diff <- ALL_Biochars_Qsd_25_High_C_diff %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_langmuir_pupaim(.)
    # Display the plot
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data
  }) %>%
  ungroup() # Ungroup after processing

#langmuir_fit_test <- langmuiranalysis(ALL_Biochars$Ammonium_moles_eq_avg[c(1:13)],ALL_Biochars$Q_NH4_avg[c(1:13)])
#Qmax <- langmuir_fit_test$plot_env$pars_Qmax
```

## Langmuir Dose Plots

### Dose Qmax Plot - Manual Langmuir

```{r}
# 
# Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25, aes(x = OC, y = Qmax, color = Type, fill = Type)) +
#   geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
#   geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
#   xlab("OC Bulk") +
#   ylab("Q max (mmol NH4/g biochar)") +
#   theme_classic(base_size = 28) +
#   theme(
#     text = element_text(family = "Times"),
#     legend.position = c(0.1, 0.8),
#     axis.text.x = element_text(size = 24),
#     axis.text.y = element_text(size = 24),
#     axis.title.x = element_text(margin = margin(t = 20), size = 24),
#     axis.title.y = element_text(margin = margin(r = 20), size = 24),
#     panel.border = element_rect(color = "black", fill = NA, size = 3),
#     legend.text = element_text(size = 20),
#     legend.title = element_text(size = 24),
#     legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
#   ) 
# 
# # Calculate R-squared value from the linear regression model
# lm_model <- lm(Qmax ~ OC, data = ALL_Biochars_Qsd_25)
# r_squared <- summary(lm_model)$r.squared 
# 
# # Add R-squared value to the plot
# Qmax_Plot <- Qmax_Plot +
#   geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
#             hjust = 1, vjust = 5, color = "black", size = 6)
# 
# Qmax_Plot
```

### Dose Qmax Plot - R Langmuir All

```{r}

Qmax_Plot <- ggplot(ALL_Biochars_Langmuir, aes(x = OC, y = Qmax_R, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax_R ~ OC, data = ALL_Biochars_Langmuir)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

#### No AO

```{r}

ALL_Biochars_Langmuir_no_AL <- ALL_Biochars_Langmuir %>% filter (Type != "AO")

Qmax_Plot <- ggplot(ALL_Biochars_Langmuir_no_AL, aes(x = OC, y = Qmax_R, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax_R ~ OC, data = ALL_Biochars_Langmuir_no_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Qmax Plot - R Langmuir Qsd \< 25%

```{r}


Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25 , aes(x = OC, y = Qmax_R, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax_R ~ OC, data = ALL_Biochars_Qsd_25)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Qmax Plot - R Langmuir High C Diff

```{r}


Qmax_Plot <- ggplot(ALL_Biochars_High_C_diff, aes(x = OC, y = Qmax_R, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax_R ~ OC, data = ALL_Biochars_High_C_diff)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Qmax Plot - R Langmuir High C Diff & Qsd \< 25

```{r}


Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_High_C_diff, aes(x = OC, y = Qmax_R, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax_R ~ OC, data = ALL_Biochars_Qsd_25_High_C_diff)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Qmax_R), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

## Summary of Langmuir Qmax plots

Didn't fit

## Dose - Freundlich Isotherm

### Freundlich Formula - Q_400

```{r, warning=FALSE}

# Define the Freundlich fitting function with plotting and Q_400 calculation
fit_freundlich_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Freundlich isotherm using PUPAIM (replace with actual function)
    freundlich_fit <- freundlichanalysis(C, Q)  # This is a placeholder for the actual fitting function
    
    # Extract parameters from the fitted model
    Kf <- freundlich_fit$plot_env$pars_KF
    n <- freundlich_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    C_target <- 300
    Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    df$Q_400 <- Q_400
    
    # Create a plot
    df$Predicted <- Kf * (C ^ (1/n))
    p <- ggplot(df, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg)) +
      geom_point() +
      geom_line(aes(y = Predicted), color = "blue") +
      labs(title = paste("Freundlich Fit for Type_ox =", unique(df$Type_ox)),
           x = "Ammonium_moles_eq_avg",
           y = "Q_NH4_avg") +
      theme_minimal()
    
    # Print the plot
    print(p)
    
    # Return both the modified dataframe and the plot
    #list(data = df, plot = p)
  }, error = function(e) {
    message("Error fitting Freundlich model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}

```

### Freundlich Fit

```{r}

ALL_Biochars_Freund <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_freundlich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup() 

ALL_Biochars_Freund <- ALL_Biochars_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)

```

```{r, warning=FALSE}

ALL_Biochars_Qsd_25_Freund <- ALL_Biochars_Qsd_25 %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_freundlich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

ALL_Biochars_Qsd_25_Freund <- ALL_Biochars_Qsd_25_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)
```

```{r}

ALL_Biochars_High_C_diff_Freund  <- ALL_Biochars_High_C_diff %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_freundlich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

ALL_Biochars_High_C_diff_Freund <- ALL_Biochars_High_C_diff_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)
```

```{r}

ALL_Biochars_Qsd_25_High_C_diff_Freund  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_freundlich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

ALL_Biochars_Qsd_25_High_C_diff_Freund <- ALL_Biochars_Qsd_25_High_C_diff_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)

#freundlich_fit_test <- freundlichanalysis(ALL_Biochars_Qsd_25$Ammonium_moles_eq_avg[c(1:13)],ALL_Biochars_Qsd_25$Q_NH4_avg[c(1:13)])
#Qmax <- langmuir_fit_test$plot_env$pars_Qmax
```

```{r}

ALL_Biochars_Qsd_25_Q_3_Freund <- ALL_Biochars_Qsd_25_Q_3 %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_freundlich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

ALL_Biochars_Qsd_25_Q_3_Freund <- ALL_Biochars_Qsd_25_Q_3_Freund %>%
  distinct(Type_ox, .keep_all = TRUE)
```

## Freundlich Dose Plots

### Dose Q-400 Plot Freundlich All Biochars

```{r}


Qmax_Plot <- ggplot(ALL_Biochars_Freund, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-400 Plot Freundlich Qsd 25%

```{r}


Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Freund, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-400 Plot Freundlich Qsd 25% no AO, AL

```{r}

ALL_Biochars_Qsd_25_Freund_no_AO_AL<- ALL_Biochars_Qsd_25_Freund%>%
    filter(!(Type %in% c("AO", "AL")))

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Freund_no_AO_AL, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Freund_no_AO_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference

```{r}

Qmax_Plot <- ggplot(ALL_Biochars_High_C_diff_Freund, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_High_C_diff_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference \$ Qsd \>25%

```{r}

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_High_C_diff_Freund, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_High_C_diff_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference - No AO, AL

```{r}

ALL_Biochars_High_C_diff_Freund_no_AO_AL <- ALL_Biochars_High_C_diff_Freund %>%
    filter(!(Type %in% c("AO", "AL")))

Qmax_Plot <- ggplot(ALL_Biochars_High_C_diff_Freund_no_AO_AL, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_High_C_diff_Freund_no_AO_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich - No AO, AL

```{r}


ALL_Biochars_Freund_no_AO_AL <- ALL_Biochars_Freund %>% 
    filter(!(Type %in% c("AO", "AL")))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_no_AO_AL, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Freund_no_AO_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich -All biochars No AO

```{r}


ALL_Biochars_Freund_no_AO <- ALL_Biochars_Freund %>% filter (Type != c("AO"))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_no_AO, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Freund_no_AO)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich High C Difference - Only AO

```{r}


ALL_Biochars_Freund_High_C_diff_AO <- ALL_Biochars_Freund %>% filter (Type == c("AO"))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_High_C_diff_AO, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Freund_High_C_diff_AO)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

```{r}


ALL_Biochars_Freund_High_C_diff_AL <- ALL_Biochars_Freund %>% filter (Type == c("AL"))

Qmax_Plot <- ggplot(ALL_Biochars_Freund_High_C_diff_AL, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Freund_High_C_diff_AL)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### Dose Q-Plot Freundlich Q \< 3, Qsd \<25%

```{r, warning=FALSE}

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Q_3_Freund)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

Qmax_Plot
```

### \*\* Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL

```{r}

ALL_Biochars_Qsd_25_Q_3_Freund_No_AL <- ALL_Biochars_Qsd_25_Q_3_Freund %>% filter (Type != c("AL"))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\*Q-Plot Freundlich Q \< 3, Qsd \<25%, No AL - OC_XPS

```{r}

# Filter out missing or non-finite values
ALL_Biochars_Qsd_25_Q_3_Freund_No_AL <- ALL_Biochars_Qsd_25_Q_3_Freund %>% 
  filter(Type != "AL" & !is.na(XPS_OC) & !is.na(Q_400))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = XPS_OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Surface") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ XPS_OC, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### \*\*Dose Q-Plot Freundlich Q \< 3, Qsd \<25% No AL Net App Diff

```{r, warning=FALSE}

Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Freund_No_AL, aes(x = net_app_H_diff_avg_abs, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("Net Apparent Proton Charge Difference") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ net_app_H_diff_avg_abs, data = ALL_Biochars_Qsd_25_Q_3_Freund_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)
```

#### General non-Linear fit

```{r}

# Function to fit data with a nonlinear model
fit_nonlinear <- function(df) {
  tryCatch({
    # Fit nonlinear model using nls
    fit <- nls(Q_NH4_avg ~ a * Ammonium_moles_eq_avg + b,
               data = df,
               start = list(a = 1, b = 0),  # Initial parameter guesses
               na.action = na.exclude)  # Exclude rows with missing values
    
    # Return the fitted parameters
    coef(fit)
  }, error = function(e) {
    message("Error fitting nonlinear model: ", e$message)
    return(NA)  # Return NA if fitting fails
  })
}
```

## Temkin Isotherm

### Temkin Formula

```{r}

# Function to fit Freundlich isotherm using PUPAIM and extract Q_400
fit_Temkin_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    T <- 298 #K
    
    # Fit Freundlich isotherm using PUPAIM
    Temkin_fit <- temkinanalysis(C, Q, T)
    
    # Extract parameters from the fitted model
    #Kf <- BET_fit$plot_env$pars_KF
   # n <- BET_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    #C_target <- 400
    #Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    #df$Q_400 <- Q_400
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = Temkin_fit)
  }, error = function(e) {
    message("Error fitting BET model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}
```

### Temkin Fit

```{r}

ALL_Biochars_Temkin <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_Temkin_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

ALL_Biochars_Qsd_25_Q_3_Temkin <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_Temkin_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()

```

### 

### 

## BET Isotherm

### BET Formula

```{r}

# Function to fit Freundlich isotherm using PUPAIM and extract Q_400
fit_BET_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Freundlich isotherm using PUPAIM
    BET_fit <- BETanalysis(C, Q)
    
    # Extract parameters from the fitted model
    #Kf <- BET_fit$plot_env$pars_KF
   # n <- BET_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    #C_target <- 400
    #Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    #df$Q_400 <- Q_400
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = BET_fit)
  }, error = function(e) {
    message("Error fitting BET model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}

```

### BET Fit

```{r}

ALL_Biochars_BET <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_BET_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

```{r}

ALL_Biochars_Qsd_25_High_C_diff_BET  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_BET_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

## Dubinin-Radushkevich Isotherm

### Dubinin-Radushkevich Formula

```{r}

# Function to fit Freundlich isotherm using PUPAIM and extract Q_400
fit_DR_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    T <- 298 #K
    
    # Fit Freundlich isotherm using PUPAIM
    DR_fit <- dubininradushkevichanalysis(C, Q, T)
    
    # Extract parameters from the fitted model
    #Kf <- BET_fit$plot_env$pars_KF
   # n <- BET_fit$plot_env$pars_n
    
    # Calculate Q at C = 400 using the Freundlich equation: Q = Kf * C^(1/n)
    #C_target <- 400
    #Q_400 <- Kf * C_target^(1/n)
    
    # Create a new column with Q_400 value repeated for each row
    #df$Q_400 <- Q_400
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = DR_fit)
  }, error = function(e) {
    message("Error fitting BET model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}

```

### Dubinin-Radushkevich Fit

```{r}

ALL_Biochars_DR <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_DR_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

```{r}

ALL_Biochars_Qsd_25_High_C_diff_DR  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_DR_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

## Elovich Isotherm

### Elovich Formula

```{r}

# Define the Elovich fitting function with plotting and Q_400 calculation
fit_Elovich_pupaim <- function(df) {
  tryCatch({
    # Prepare data for PUPAIM
    C <- df$Ammonium_moles_eq_avg
    Q <- df$Q_NH4_avg
    
    # Fit Elovich isotherm using PUPAIM
    elovich_fit <- elovichanalysis(C, Q)
    
    # Extract parameters from the fitted model
    KE <- elovich_fit$plot_env$pars_KE
    QmE <- elovich_fit$plot_env$pars_QmE
    
    # Calculate Q at C = 400 using the Elovich equation: Q = C / (QmE * KE * exp(-C/QmE))
    C_target <- 300
    Q_400 <- C_target / (QmE * KE * exp(-C_target / QmE))
    
    # Create a new column with Q_400 value repeated for each row
    df$Q_400 <- Q_400
    
    # Create a plot
    df$Predicted <- C / (QmE * KE * exp(-C / QmE))
    p <- ggplot(df, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg)) +
      geom_point() +
      geom_line(aes(y = Predicted), color = "blue") +
      labs(title = paste("Elovich Fit for Type_ox =", unique(df$Type_ox)),
           x = "Ammonium_moles_eq_avg",
           y = "Q_NH4_avg") +
      theme_minimal()
    
    # Print the plot
    print(p)
    
    # Return both the modified dataframe and the plot
    list(data = df, plot = p)
  }, error = function(e) {
    message("Error fitting Elovich model for Type_ox =", unique(df$Type_ox), ": ", e$message)
    #df$Q_400 <- NA  # Assign NA if fitting fails
    return(list(data = df, plot = NULL))
  })
}
```

### Elovich Fit

```{r}

ALL_Biochars_Elovich <- ALL_Biochars %>%
  group_by(Type_ox) %>%
  do({
    result <- fit_Elovich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

```{r}

ALL_Biochars_Qsd_25_High_C_diff_Elovich  <- ALL_Biochars_Qsd_25_High_C_diff %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_Elovich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup() 
```

```{r}

ALL_Biochars_Qsd_25_Q_3_Elovich  <- ALL_Biochars_Qsd_25_Q_3 %>% 
  group_by(Type_ox) %>%
  do({
    result <- fit_Elovich_pupaim(.)
    # Print the plot if it exists
    if (!is.null(result$plot)) {
      print(result$plot)
    }
    result$data  # Return only the modified dataframe
  }) %>%
  ungroup()
```

### \*\* Dose Q-Plot Elovich Q \< 3, Qsd \<25% No AL

```{r}

ALL_Biochars_Qsd_25_Q_3_Elovich_No_AL <- ALL_Biochars_Qsd_25_Q_3_Elovich %>% filter (Type != c("AL"))
```

```{r, warning=FALSE}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_Elovich_No_AL, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Q_3_Elovich_No_AL)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)

```

### 

## Non-Linear Fit

```{r}
# Load the required libraries
library(minpack.lm)

# Define the nonlinear fitting function with plotting and Q_400 calculation
fit_nonlinear <- function(df) {
  tryCatch({
    # Define ranges for initial parameter guesses
    a_range <- seq(0.05, 6, by = 0.1)  # Adjust the range as needed
    b_range <- seq(0.5, 2, by = 0.1)  # Adjust the range as needed
    
    # Iterate over the ranges and fit the model with each combination of initial guesses
    for (a_guess in a_range) {
      for (b_guess in b_range) {
        fit <- try(nlsLM(Q_NH4_avg ~ a * (Ammonium_moles_eq_avg ^ (1/b)),
                         data = df,
                         start = list(a = a_guess, b = b_guess),
                         na.action = na.exclude,
                         control = nls.lm.control(maxiter = 100, ftol = 1e-10)))
        if (!inherits(fit, "try-error")) {
          # Print summary of the fit
          print(summary(fit))
          
          # Calculate Q_NH4_avg at Ammonium_moles_eq_avg of 400
          C_target <- 300
          a <- coef(fit)["a"]
          b <- coef(fit)["b"]
          Q_400 <- a * (C_target ^ (1/b))
          
         # Create a plot
          df$Predicted <- predict(fit)
          df$Q_400 <- Q_400
          p <- ggplot(df, aes(x = Ammonium_moles_eq_avg, y = Q_NH4_avg)) +
            geom_point() +
            geom_line(aes(y = Predicted), color = "blue") +
            labs(title = paste("Nonlinear Fit for Type_ox =", unique(df$Type_ox)),
                 x = "Ammonium_moles_eq_avg",
                 y = "Q_NH4_avg") +
            theme_minimal()
          
          # Print the plot
          print(p)
          
          return(df)
        }
      }
    }
    # If none of the combinations converge, return NA
    message("Failed to converge with all initial guesses.")
    df$Q_400 <- NA
    return(df)
  }, error = function(e) {
    message("Error fitting nonlinear model: ", e$message)
    df$Q_400 <- NA
    return(df)
  })
}
```

### Non-linear fit

```{r}

# Apply the function to each group
ALL_Biochars_Qsd_25_High_C_diff_nls <- ALL_Biochars_Qsd_25_High_C_diff %>%
  group_by(Type_ox) %>%
  do(fit_nonlinear(.)) %>%
  ungroup()

```

```{r}

ALL_Biochars_Qsd_25_Q_3_nls <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(fit_nonlinear(.)) %>%
  ungroup()
```

### Non-Linear plots

```{r}
ALL_Biochars_Qsd_25_Q_3_nls <- ALL_Biochars_Qsd_25_Q_3_nls %>% filter(Type != "AL")
```

```{r}

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_nls, aes(x = OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ OC, data = ALL_Biochars_Qsd_25_Q_3_nls)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)


```

```{r}
ALL_Biochars_Qsd_25_Q_3_nls_XPS <- ALL_Biochars_Qsd_25_Q_3_nls %>% 
    filter(Type != "AL" & !is.na(XPS_OC) & !is.na(Q_400))

# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_nls_XPS, aes(x = XPS_OC, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ XPS_OC, data = ALL_Biochars_Qsd_25_Q_3_nls_XPS)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(XPS_OC), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)


```

```{r}


# Create the plot with unique data
Qmax_Plot <- ggplot(ALL_Biochars_Qsd_25_Q_3_nls, aes(x = net_app_H_diff_avg_abs, y = Q_400, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = TRUE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Bulk") +
  ylab("Q (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )

# Fit the linear regression model to the unique data
lm_model <- lm(Q_400 ~ net_app_H_diff_avg_abs, data = ALL_Biochars_Qsd_25_Q_3_nls)

# Summary of the regression model
summary_lm <- summary(lm_model)

# Calculate R-squared value and regression details
r_squared <- summary_lm$r.squared
p_value <- summary_lm$coefficients[2, 4]  # Extracting the p-value for the slope
equation <- paste("Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC")
significance <- ifelse(p_value < 0.001, "***", ifelse(p_value < 0.01, "**", ifelse(p_value < 0.05, "*", "ns")))

# Extract the F-statistic and degrees of freedom
f_statistic <- summary_lm$fstatistic[1]
df1 <- summary_lm$fstatistic[2]
df2 <- summary_lm$fstatistic[3]

# Extract the standard deviation of residuals (example of what S25 could represent)
residual_sd <- sd(summary_lm$residuals)

# Output the regression details
cat("Equation: Q_max =", round(coef(lm_model)[1], 2), "+", round(coef(lm_model)[2], 2), "* OC\n")
cat("R^2: ", round(r_squared, 2), "\n")
cat("p-value: ", p_value, "(", significance, ")\n")
cat("F-statistic: F(", df1, ",", df2, ") = ", round(f_statistic, 2), "\n")
cat("Standard deviation of residuals (S25): ", round(residual_sd, 2), "\n")

# Add R-squared value to the plot
Qmax_Plot <- Qmax_Plot +
  geom_text(aes(x = max(net_app_H_diff_avg_abs), y = max(Q_400), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5, color = "black", size = 6)

# Display the plot
print(Qmax_Plot)
```

## Comparing all isotherms

```{r}

# Function to extract adjusted R-squared values for Langmuir
fit_langmuir_pupaim <- function(df) {
  # Prepare data for PUPAIM
  C <- df$Ammonium_moles_eq_avg
  Q <- df$Q_NH4_avg
  
  # Capture the output of langmuiranalysis (replace with actual fitting function)
  langmuir_fit_test_output <- capture.output(langmuiranalysis(C, Q))
  
  # Extract the Adjusted R-squared value
  adjusted_r_squared_line <- grep("Adjusted R-squared", langmuir_fit_test_output, value = TRUE)
  
  if (length(adjusted_r_squared_line) == 0) {
    adjusted_r_squared_value <- NA
  } else {
    adjusted_r_squared_value <- as.numeric(sub(".*Adjusted R-squared: *", "", adjusted_r_squared_line))
  }
  
  # Return a named list
  return(list(Langmuir_adj_r2 = adjusted_r_squared_value))
}

# Function to extract adjusted R-squared values for Temkin
fit_Temkin_pupaim <- function(df) {
  C <- df$Ammonium_moles_eq_avg
  Q <- df$Q_NH4_avg
  T <- 298 # K
    
  # Capture the output of temkinanalysis
  Temkin_fit_test_output <- capture.output(temkinanalysis(C, Q, T))
    
  # Extract the Adjusted R-squared value
  adjusted_r_squared_line <- grep("Adjusted R-squared", Temkin_fit_test_output, value = TRUE)
  adjusted_r_squared_value <- as.numeric(sub(".*Adjusted R-squared: *", "", adjusted_r_squared_line))
  
  # Return a named list
  return(list(Temkin_adj_r2 = adjusted_r_squared_value))
}

# Function to extract adjusted R-squared values for Freundlich
fit_freundlich_pupaim <- function(df) {
  # Prepare data for PUPAIM
  C <- df$Ammonium_moles_eq_avg
  Q <- df$Q_NH4_avg
  
  # Capture the output of freundlichanalysis (replace with actual fitting function)
  freundlich_fit_test_output <- capture.output(freundlichanalysis(C, Q))
  
  # Extract the Adjusted R-squared value
  adjusted_r_squared_line <- grep("Adjusted R-squared", freundlich_fit_test_output, value = TRUE)
  adjusted_r_squared_value <- as.numeric(sub(".*Adjusted R-squared: *", "", adjusted_r_squared_line))
  
  # Return a named list
  return(list(Freundlich_adj_r2 = adjusted_r_squared_value))
}

# Function to extract adjusted R-squared values for DR
fit_DR_pupaim <- function(df) {
  C <- df$Ammonium_moles_eq_avg
  Q <- df$Q_NH4_avg
  T <- 298 # K
    
  # Capture the output of Dubinin-Radushkevich isotherm analysis
  DR_fit_output <- capture.output(dubininradushkevichanalysis(C, Q, T))
  print(DR_fit_output)
    
  # Extract the Adjusted R-squared value
  adjusted_r_squared_line <- grep("Adjusted R-squared", DR_fit_output, value = TRUE)
  adjusted_r_squared_value <- as.numeric(sub(".*Adjusted R-squared: *", "", adjusted_r_squared_line))
  
  # Return as data frame
  data.frame(DR_adj_r2 = adjusted_r_squared_value)
}

# Function to extract adjusted R-squared values for Elovich
fit_elovich_pupaim <- function(df) {
  # Prepare data for PUPAIM
  C <- df$Ammonium_moles_eq_avg
  Q <- df$Q_NH4_avg
  
  # Capture the output of Elovich analysis (replace with actual fitting function)
  elovich_fit_test_output <- capture.output(elovichanalysis(C, Q))
  
  # Extract the Adjusted R-squared value
  adjusted_r_squared_line <- grep("Adjusted R-squared", elovich_fit_test_output, value = TRUE)
  
  if (length(adjusted_r_squared_line) == 0) {
    adjusted_r_squared_value <- NA
  } else {
    adjusted_r_squared_value <- as.numeric(sub(".*Adjusted R-squared: *", "", adjusted_r_squared_line))
  }
  
  # Return a named list
  data.frame(Elovich_adj_r2 = adjusted_r_squared_value)
}

# # Function to extract adjusted R-squared values for BET
# fit_bet_pupaim <- function(df) {
#   # Prepare data for PUPAIM
#   C <- df$Ammonium_moles_eq_avg
#   Q <- df$Q_NH4_avg
#   
#   # Capture the output of BET analysis (replace with actual fitting function)
#   bet_fit_test_output <- capture.output(BETanalysis(C, Q))
#   
#   # Extract the Adjusted R-squared value
#   adjusted_r_squared_line <- grep("Adjusted R-squared", bet_fit_test_output, value = TRUE)
#   
#   if (length(adjusted_r_squared_line) == 0) {
#     adjusted_r_squared_value <- NA
#   } else {
#     adjusted_r_squared_value <- as.numeric(sub(".*Adjusted R-squared: *", "", adjusted_r_squared_line))
#   }
#   
#   # Return a named list
#   return(list(BET_adj_r2 = adjusted_r_squared_value))
# }

#---------------------------------------------------------------------------------

# Apply the Langmuir function to each group
adjusted_r2_langmuir_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_langmuir_pupaim(.)) %>%
  mutate(Langmuir_adj_r2 = result$Langmuir_adj_r2) %>%
  select(-result)

# Apply the Temkin function to each group
adjusted_r2_temkin_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_Temkin_pupaim(.)) %>%
  mutate(Temkin_adj_r2 = result$Temkin_adj_r2) %>%
  select(-result)

# Apply the Freundlich function to each group
adjusted_r2_freundlich_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(result = fit_freundlich_pupaim(.)) %>%
  mutate(Freundlich_adj_r2 = result$Freundlich_adj_r2) %>%
  select(-result)

# Apply the DR function to each group and combine the results
adjusted_r2_DR_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(fit_DR_pupaim(.)) %>%
  ungroup()

# Apply the Elovich function to each group
adjusted_r2_elovich_df <- ALL_Biochars_Qsd_25_Q_3 %>%
  group_by(Type_ox) %>%
  do(fit_elovich_pupaim(.)) %>%
  ungroup()

# # Apply the BET function to each group
# adjusted_r2_bet_df <- ALL_Biochars_Qsd_25_Q_3 %>%
#   group_by(Type_ox) %>%
#   do(fit_bet_pupaim(.)) %>%
#   ungroup()

# Combine the data frames
adjusted_r2_combined <- adjusted_r2_temkin_df %>%
  left_join(adjusted_r2_freundlich_df, by = "Type_ox") %>%
  left_join(adjusted_r2_langmuir_df, by = "Type_ox") %>%
  left_join(adjusted_r2_DR_df, by = "Type_ox") %>%
  left_join(adjusted_r2_elovich_df, by = "Type_ox")

# Print the combined data frame
adjusted_r2_combined

```

### Other

```{r, warning=FALSE}

Dilution_Data_filtered <- Dilution_Data %>% filter(!is.na(XPS_OC))

Qmax_Plot_XPS <- ggplot(Dilution_Data_filtered, aes(x = XPS_OC, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a single linear regression line for all data points
  xlab("OC Surface") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  ) 

# Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax ~ XPS_OC, data = Dilution_Data_filtered)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
Qmax_Plot_XPS <- Qmax_Plot_XPS +
  geom_text(aes(x = max(Dilution_Data_filtered$XPS_OC)*0.9, y = max(Dilution_Data_filtered$Qmax)*0.9, label = paste("R^2 =", round(r_squared, 2))),
            hjust = 0.5, vjust = 7.5, color = "black", size = 6)

Qmax_Plot_XPS
```

```{r}

# # Define a function to fit Langmuir isotherm and extract Qmax
# fit_langmuir <- function(df) {
#   # Fit Langmuir isotherm
#   fit <- langmuir1.LM(Ce = df$Ammonium_moles_eq_avg, Qe = df$Q_NH4_avg)
#   
#   # Extract Qmax value from the fit
#   Qmax <- fit$Qmax
#   
#   # Return Qmax value
#   return(Qmax)
# }
# 
# # Apply the function to each subset of data based on Type_ox
# Dilution_Data_2 <- Dilution_Data %>%
#   filter(Type_ox %in% c("AK_30")) %>%
#   group_split(Type_ox) %>%
#   map_dbl(~fit_langmuir(.))

```

Net App Plot

```{r, warning=FALSE}

NetApp_Plot <- ggplot(Dilution_Data, aes(x = net_app_H_diff_avg_abs, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a linear regression line
  xlab("Net Apparent H Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.8, 0.4),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )
    
    # Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax ~ net_app_H_diff_avg_abs, data = Dilution_Data)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
NetApp_Plot <- NetApp_Plot +
  geom_text(aes(x = max(Dilution_Data$net_app_H_diff_avg_abs), y = max(Dilution_Data$Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 5.5, color = "black", size = 6)
 
NetApp_Plot
```

Net App Plot without potential outlier

```{r, warning=FALSE}

Dilution_Data_no_AO <- Dilution_Data %>% filter(Type_ox != "AO_20")

NetApp_Plot_no_AO <- ggplot(Dilution_Data_no_AO, aes(x = net_app_H_diff_avg_abs, y = Qmax, color = Type, fill = Type)) +
  geom_point(shape = 21, size = 6, stroke = 2, color = "black") +
    geom_smooth(method = "lm", se = FALSE, color = "blue", aes(group = 1)) +  # Fit a linear regression line
  xlab("Net Apparent H Charge Difference") +
  ylab("Q max (mmol NH4/g biochar)") +
  theme_classic(base_size = 28) +
  theme(
    text = element_text(family = "Times"),
    legend.position = c(0.1, 0.8),
    axis.text.x = element_text(size = 24),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(margin = margin(t = 20), size = 24),
    axis.title.y = element_text(margin = margin(r = 20), size = 24),
    panel.border = element_rect(color = "black", fill = NA, size = 3),
    legend.text = element_text(size = 20),
    legend.title = element_text(size = 24),
    legend.box.background = element_rect(color = "black", size = 1, linetype = "solid")
  )
    
    # Calculate R-squared value from the linear regression model
lm_model <- lm(Qmax ~ net_app_H_diff_avg_abs, data = Dilution_Data_no_AO)
r_squared <- summary(lm_model)$r.squared

# Add R-squared value to the plot
NetApp_Plot_no_AO <- NetApp_Plot_no_AO +
  geom_text(aes(x = max(Dilution_Data_no_AO$net_app_H_diff_avg_abs), y = max(Dilution_Data_no_AO$Qmax), label = paste("R^2 =", round(r_squared, 2))),
            hjust = 1, vjust = 4, color = "black", size = 6)
 
NetApp_Plot_no_AO
```
